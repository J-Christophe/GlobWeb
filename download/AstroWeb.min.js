/**
 * almond 0.2.5 Copyright (c) 2011-2012, The Dojo Foundation All Rights Reserved.
 * Available via the MIT or new BSD license.
 * see: http://github.com/jrburke/almond for details
 */

/***************************************
 * Copyright 2011, 2012 GlobWeb contributors.
 *
 * This file is part of GlobWeb.
 *
 * GlobWeb is free software: you can redistribute it and/or modify
 * it under the terms of the GNU Lesser General Public License as published by
 * the Free Software Foundation, version 3 of the License, or
 * (at your option) any later version.
 *
 * GlobWeb is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 * GNU Lesser General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with GlobWeb. If not, see <http://www.gnu.org/licenses/>.
 ***************************************/

/*
 * Copyright (c) 2012 Brandon Jones, Colin MacKenzie IV
 *
 * This software is provided 'as-is', without any express or implied
 * warranty. In no event will the authors be held liable for any damages
 * arising from the use of this software.
 *
 * Permission is granted to anyone to use this software for any purpose,
 * including commercial applications, and to alter it and redistribute it
 * freely, subject to the following restrictions:
 *
 *    1. The origin of this software must not be misrepresented; you must not
 *    claim that you wrote the original software. If you use this software
 *    in a product, an acknowledgment in the product documentation would be
 *    appreciated but is not required.
 *
 *    2. Altered source versions must be plainly marked as such, and must not
 *    be misrepresented as being the original software.
 *
 *    3. This notice may not be removed or altered from any source
 *    distribution.
 */

/***************************************
 * Copyright 2011, 2012 GlobWeb contributors.
 *
 * This file is part of GlobWeb.
 *
 * GlobWeb is free software: you can redistribute it and/or modify
 * it under the terms of the GNU Lesser General Public License as published by
 * the Free Software Foundation, version 3 of the License, or
 * (at your option) any later version.
 *
 * GlobWeb is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 * GNU Lesser General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with  If not, see <http://www.gnu.org/licenses/>.
 ***************************************/

/***************************************
 * Copyright 2009 The Closure Library Authors. All Rights Reserved. (Apache License, Version 2.0)
 * Copyright 2011, 2012 GlobWeb contributors.
 *
 * This file is part of GlobWeb.
 *
 * GlobWeb is free software: you can redistribute it and/or modify
 * it under the terms of the GNU Lesser General Public License as published by
 * the Free Software Foundation, version 3 of the License, or
 * (at your option) any later version.
 *
 * GlobWeb is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 * GNU Lesser General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with GlobWeb. If not, see <http://www.gnu.org/licenses/>.
 ***************************************/

/***************************************
 * Copyright 2011, 2012 GlobWeb contributors.
 *
 * This file is part of GlobWeb.
 *  Ported from HEALPix Java code supported by the Gaia project.
 * 	Copyright (C) 2006-2011 Gaia Data Processing and Analysis Consortium
 *
 * GlobWeb is free software: you can redistribute it and/or modify
 * it under the terms of the GNU Lesser General Public License as published by
 * the Free Software Foundation, version 3 of the License, or
 * (at your option) any later version.
 *
 * GlobWeb is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 * GNU Lesser General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with GlobWeb. If not, see <http://www.gnu.org/licenses/>.
 ***************************************/

/**************************************
 * Copyright 2011, 2012 GlobWeb contributors.
 *
 * This file is part of GlobWeb.
 *
 * GlobWeb is free software: you can redistribute it and/or modify
 * it under the terms of the GNU Lesser General Public License as published by
 * the Free Software Foundation, version 3 of the License, or
 * (at your option) any later version.
 *
 * GlobWeb is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 * GNU Lesser General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with GlobWeb. If not, see <http://www.gnu.org/licenses/>.
 ***************************************/

(function(){var e,t,r;(function(i){function n(e,t){return y.call(e,t)}function o(e,t){var r,i,n,o,s,a,l,h,u,f,c=t&&t.split("/"),d=x.map,m=d&&d["*"]||{};if(e&&"."===e.charAt(0))if(t){for(c=c.slice(0,c.length-1),e=c.concat(e.split("/")),h=0;e.length>h;h+=1)if(f=e[h],"."===f)e.splice(h,1),h-=1;else if(".."===f){if(1===h&&(".."===e[2]||".."===e[0]))break;h>0&&(e.splice(h-1,2),h-=2)}e=e.join("/")}else 0===e.indexOf("./")&&(e=e.substring(2));if((c||m)&&d){for(r=e.split("/"),h=r.length;h>0;h-=1){if(i=r.slice(0,h).join("/"),c)for(u=c.length;u>0;u-=1)if(n=d[c.slice(0,u).join("/")],n&&(n=n[i])){o=n,s=h;break}if(o)break;!a&&m&&m[i]&&(a=m[i],l=h)}!o&&a&&(o=a,s=l),o&&(r.splice(0,s,o),e=r.join("/"))}return e}function s(e,t){return function(){return d.apply(i,T.call(arguments,0).concat([e,t]))}}function a(e){return function(t){return o(t,e)}}function l(e){return function(t){v[e]=t}}function h(e){if(n(g,e)){var t=g[e];delete g[e],b[e]=!0,c.apply(i,t)}if(!n(v,e)&&!n(b,e))throw Error("No "+e);return v[e]}function u(e){var t,r=e?e.indexOf("!"):-1;return r>-1&&(t=e.substring(0,r),e=e.substring(r+1,e.length)),[t,e]}function f(e){return function(){return x&&x.config&&x.config[e]||{}}}var c,d,m,p,v={},g={},x={},b={},y=Object.prototype.hasOwnProperty,T=[].slice;m=function(e,t){var r,i=u(e),n=i[0];return e=i[1],n&&(n=o(n,t),r=h(n)),n?e=r&&r.normalize?r.normalize(e,a(t)):o(e,t):(e=o(e,t),i=u(e),n=i[0],e=i[1],n&&(r=h(n))),{f:n?n+"!"+e:e,n:e,pr:n,p:r}},p={require:function(e){return s(e)},exports:function(e){var t=v[e];return t!==void 0?t:v[e]={}},module:function(e){return{id:e,uri:"",exports:v[e],config:f(e)}}},c=function(e,t,r,o){var a,u,f,c,d,x,y=[];if(o=o||e,"function"==typeof r){for(t=!t.length&&r.length?["require","exports","module"]:t,d=0;t.length>d;d+=1)if(c=m(t[d],o),u=c.f,"require"===u)y[d]=p.require(e);else if("exports"===u)y[d]=p.exports(e),x=!0;else if("module"===u)a=y[d]=p.module(e);else if(n(v,u)||n(g,u)||n(b,u))y[d]=h(u);else{if(!c.p)throw Error(e+" missing "+u);c.p.load(c.n,s(o,!0),l(u),{}),y[d]=v[u]}f=r.apply(v[e],y),e&&(a&&a.exports!==i&&a.exports!==v[e]?v[e]=a.exports:f===i&&x||(v[e]=f))}else e&&(v[e]=r)},e=t=d=function(e,t,r,n,o){return"string"==typeof e?p[e]?p[e](t):h(m(e,t).f):(e.splice||(x=e,t.splice?(e=t,t=r,r=null):e=i),t=t||function(){},"function"==typeof r&&(r=n,n=o),n?c(i,e,t,r):setTimeout(function(){c(i,e,t,r)},4),d)},d.config=function(e){return x=e,x.deps&&d(x.deps,x.callback),d},r=function(e,t,r){t.splice||(r=t,t=[]),n(v,e)||n(g,e)||(g[e]=[e,t,r])},r.amd={jQuery:!0}})(),r("../build/almond",function(){}),r("Numeric",[],function(){var e={};return e.lerp=function(e,t,r){return t+(r-t)*e},e.cubicInterpolation=function(e,t,r,i,n){var o=e*e,s=o*e,a=2*t[0]-2*i[0]+r[0]+n[0],l=2*t[1]-2*i[1]+r[1]+n[1],h=2*t[2]-2*i[2]+r[2]+n[2],u=-3*t[0]+3*i[0]-2*r[0]-n[0],f=-3*t[1]+3*i[1]-2*r[1]-n[1],c=-3*t[2]+3*i[2]-2*r[2]-n[2],d=vec3.create();return d[0]=a*s+u*o+r[0]*e+t[0],d[1]=l*s+f*o+r[1]*e+t[1],d[2]=h*s+c*o+r[2]*e+t[2],d},e.cubicInterpolationDerivative=function(e,t,r,i,n){var o=e*e,s=6*t[0]-6*i[0]+3*r[0]+3*n[0],a=6*t[1]-6*i[1]+3*r[1]+3*n[1],l=6*t[2]-6*i[2]+3*r[2]+3*n[2],h=-6*t[0]+6*i[0]-4*r[0]-2*n[0],u=-6*t[1]+6*i[1]-4*r[1]-2*n[1],f=-6*t[2]+6*i[2]-4*r[2]-2*n[2],c=vec3.create();return c[0]=s*o+h*e+r[0],c[1]=a*o+u*e+r[1],c[2]=l*o+f*e+r[2],c},e.map01=function(e,t,r){return t!=r?(e-t)/(r-t):0},e.mapLinear=function(t,r,i,n,o){return e.lerp(e.map01(t,r,i),n,o)},e.easeInQuad=function(e){return e*e},e.easeOutQuad=function(e){var t=e-1;return 1-t*t},e.easeInOutQuad=function(e){var t=e;return.5>t?(t+=t,t=.5*t*t):(t=t+t-2,t=.5*(1-t*t),t=.5+t),t},e.easeOutInQuad=function(e){var t=e;return.5>t?(t=t+t-1,t=.5*(1-t*t)):(t=t+t-1,t=.5*t*t,t=.5+t),t},e.toRadian=function(e){return e*Math.PI/180},e.toDegree=function(e){return 180*e/Math.PI},e.pointOnRay=function(e,t,r,i){return i||(i=vec3.create()),vec3.scale(t,r,i),vec3.add(i,e,i),i},e.lineIntersection=function(e,t,r,i,n,o,s,a){var l=(a-o)*(r-e)-(s-n)*(i-t);if(0==l)return[-1,-1];var h=(s-n)*(t-o)-(a-o)*(e-n),u=(r-e)*(t-o)-(i-t)*(e-n);return h/=l,u/=l,[h,u]},e.raySphereIntersection=function(e,t,r,i){var n=vec3.subtract(e,r,vec3.create()),o=2*vec3.dot(t,n),s=vec3.dot(n,n)-i*i,a=o*o-4*s;if(0>a)return-1;a=Math.sqrt(a);var l=(-o-a)/2,h=(-o+a)/2;if(l>h){var u=l;l=h,h=u}return 0>h?-1:0>l?h:l},e.roundNumber=function(e,t){var r=Math.round(e*Math.pow(10,t))/Math.pow(10,t);return r},e}),r("CoordinateSystem",["./Numeric"],function(e){var t={radius:1,heightScale:1/6356752.3142,realEarthRadius:6356752.3142};return t.fromGeoTo3D=function(r,i){i||(i=Array(3));var n=e.toRadian(r[0]),o=e.toRadian(r[1]),s=Math.cos(o),a=r.length>2?t.heightScale*r[2]:0,l=t.radius+a;return i[0]=l*Math.cos(n)*s,i[1]=l*Math.sin(n)*s,i[2]=l*Math.sin(o),i},t.from3DToGeo=function(r,i){i||(i=Array(3));var n=Math.sqrt(r[0]*r[0]+r[1]*r[1]+r[2]*r[2]),o=Math.atan2(r[1]/n,r[0]/n),s=Math.asin(r[2]/n);return i[0]=e.toDegree(o),i[1]=e.toDegree(s),i[2]=t.realEarthRadius*(n-t.radius),i},t.getLocalTransform=function(e,t){t||(t=mat4.create());var r=e[0]*Math.PI/180,i=e[1]*Math.PI/180,n=[Math.cos(r)*Math.cos(i),Math.sin(r)*Math.cos(i),Math.sin(i)],o=[-Math.sin(r),Math.cos(r),0],s=vec3.create();return vec3.cross(n,o,s),t[0]=o[0],t[1]=o[1],t[2]=o[2],t[3]=0,t[4]=s[0],t[5]=s[1],t[6]=s[2],t[7]=0,t[8]=n[0],t[9]=n[1],t[10]=n[2],t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t},t.getLHVTransform=function(e,r){r||(r=mat4.create());var i=e[0]*Math.PI/180,n=e[1]*Math.PI/180,o=[Math.cos(i)*Math.cos(n),Math.sin(i)*Math.cos(n),Math.sin(n)],s=[-Math.sin(i),Math.cos(i),0],a=vec3.create();vec3.cross(o,s,a);var l=t.fromGeoTo3D(e);return r[0]=s[0],r[1]=s[1],r[2]=s[2],r[3]=0,r[4]=a[0],r[5]=a[1],r[6]=a[2],r[7]=0,r[8]=o[0],r[9]=o[1],r[10]=o[2],r[11]=0,r[12]=l[0],r[13]=l[1],r[14]=l[2],r[15]=1,r},t.getSideVector=function(e,t){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t},t.getFrontVector=function(e,t){return t[0]=e[4],t[1]=e[5],t[2]=e[6],t},t.getUpVector=function(e,t){return t[0]=e[8],t[1]=e[9],t[2]=e[10],t},t}),function(e){var t=1e-6,r=Array,i={};i.create=function(e){var t=new r(3);return e?(t[0]=e[0],t[1]=e[1],t[2]=e[2]):t[0]=t[1]=t[2]=0,t},i.createFrom=function(e,t,i){var n=new r(3);return n[0]=e,n[1]=t,n[2]=i,n},i.set=function(e,t){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t},i.equal=function(e,r){return e===r||t>Math.abs(e[0]-r[0])&&t>Math.abs(e[1]-r[1])&&t>Math.abs(e[2]-r[2])},i.add=function(e,t,r){return r&&e!==r?(r[0]=e[0]+t[0],r[1]=e[1]+t[1],r[2]=e[2]+t[2],r):(e[0]+=t[0],e[1]+=t[1],e[2]+=t[2],e)},i.subtract=function(e,t,r){return r&&e!==r?(r[0]=e[0]-t[0],r[1]=e[1]-t[1],r[2]=e[2]-t[2],r):(e[0]-=t[0],e[1]-=t[1],e[2]-=t[2],e)},i.multiply=function(e,t,r){return r&&e!==r?(r[0]=e[0]*t[0],r[1]=e[1]*t[1],r[2]=e[2]*t[2],r):(e[0]*=t[0],e[1]*=t[1],e[2]*=t[2],e)},i.negate=function(e,t){return t||(t=e),t[0]=-e[0],t[1]=-e[1],t[2]=-e[2],t},i.scale=function(e,t,r){return r&&e!==r?(r[0]=e[0]*t,r[1]=e[1]*t,r[2]=e[2]*t,r):(e[0]*=t,e[1]*=t,e[2]*=t,e)},i.normalize=function(e,t){t||(t=e);var r=e[0],i=e[1],n=e[2],o=Math.sqrt(r*r+i*i+n*n);return o?1===o?(t[0]=r,t[1]=i,t[2]=n,t):(o=1/o,t[0]=r*o,t[1]=i*o,t[2]=n*o,t):(t[0]=0,t[1]=0,t[2]=0,t)},i.cross=function(e,t,r){r||(r=e);var i=e[0],n=e[1],o=e[2],s=t[0],a=t[1],l=t[2];return r[0]=n*l-o*a,r[1]=o*s-i*l,r[2]=i*a-n*s,r},i.length=function(e){var t=e[0],r=e[1],i=e[2];return Math.sqrt(t*t+r*r+i*i)},i.squaredLength=function(e){var t=e[0],r=e[1],i=e[2];return t*t+r*r+i*i},i.dot=function(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]},i.lerp=function(e,t,r,i){return i||(i=e),i[0]=e[0]+r*(t[0]-e[0]),i[1]=e[1]+r*(t[1]-e[1]),i[2]=e[2]+r*(t[2]-e[2]),i},i.dist=function(e,t){var r=t[0]-e[0],i=t[1]-e[1],n=t[2]-e[2];return Math.sqrt(r*r+i*i+n*n)},new r(4),i.str=function(e){return"["+e[0]+", "+e[1]+", "+e[2]+"]"};var n={};n.create=function(e){var t=new r(16);return e&&(t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t},n.set=function(e,t){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15],t},n.identity=function(e){return e||(e=n.create()),e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e},n.transpose=function(e,t){if(!t||e===t){var r=e[1],i=e[2],n=e[3],o=e[6],s=e[7],a=e[11];return e[1]=e[4],e[2]=e[8],e[3]=e[12],e[4]=r,e[6]=e[9],e[7]=e[13],e[8]=i,e[9]=o,e[11]=e[14],e[12]=n,e[13]=s,e[14]=a,e}return t[0]=e[0],t[1]=e[4],t[2]=e[8],t[3]=e[12],t[4]=e[1],t[5]=e[5],t[6]=e[9],t[7]=e[13],t[8]=e[2],t[9]=e[6],t[10]=e[10],t[11]=e[14],t[12]=e[3],t[13]=e[7],t[14]=e[11],t[15]=e[15],t},n.determinant=function(e){var t=e[0],r=e[1],i=e[2],n=e[3],o=e[4],s=e[5],a=e[6],l=e[7],h=e[8],u=e[9],f=e[10],c=e[11],d=e[12],m=e[13],p=e[14],v=e[15];return d*u*a*n-h*m*a*n-d*s*f*n+o*m*f*n+h*s*p*n-o*u*p*n-d*u*i*l+h*m*i*l+d*r*f*l-t*m*f*l-h*r*p*l+t*u*p*l+d*s*i*c-o*m*i*c-d*r*a*c+t*m*a*c+o*r*p*c-t*s*p*c-h*s*i*v+o*u*i*v+h*r*a*v-t*u*a*v-o*r*f*v+t*s*f*v},n.inverse=function(e,t){t||(t=e);var r,i=e[0],n=e[1],o=e[2],s=e[3],a=e[4],l=e[5],h=e[6],u=e[7],f=e[8],c=e[9],d=e[10],m=e[11],p=e[12],v=e[13],g=e[14],x=e[15],b=i*l-n*a,y=i*h-o*a,T=i*u-s*a,R=n*h-o*l,_=n*u-s*l,E=o*u-s*h,M=f*v-c*p,A=f*g-d*p,C=f*x-m*p,F=c*g-d*v,I=c*x-m*v,S=d*x-m*g,w=b*S-y*I+T*F+R*C-_*A+E*M;return w?(r=1/w,t[0]=(l*S-h*I+u*F)*r,t[1]=(-n*S+o*I-s*F)*r,t[2]=(v*E-g*_+x*R)*r,t[3]=(-c*E+d*_-m*R)*r,t[4]=(-a*S+h*C-u*A)*r,t[5]=(i*S-o*C+s*A)*r,t[6]=(-p*E+g*T-x*y)*r,t[7]=(f*E-d*T+m*y)*r,t[8]=(a*I-l*C+u*M)*r,t[9]=(-i*I+n*C-s*M)*r,t[10]=(p*_-v*T+x*b)*r,t[11]=(-f*_+c*T-m*b)*r,t[12]=(-a*F+l*A-h*M)*r,t[13]=(i*F-n*A+o*M)*r,t[14]=(-p*R+v*y-g*b)*r,t[15]=(f*R-c*y+d*b)*r,t):null},n.toRotationMat=function(e,t){return t||(t=n.create()),t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=0,t[13]=0,t[14]=0,t[15]=1,t},n.toMat3=function(e,t){return t||(t=mat3.create()),t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[4],t[4]=e[5],t[5]=e[6],t[6]=e[8],t[7]=e[9],t[8]=e[10],t},n.multiply=function(e,t,r){r||(r=e);var i=e[0],n=e[1],o=e[2],s=e[3],a=e[4],l=e[5],h=e[6],u=e[7],f=e[8],c=e[9],d=e[10],m=e[11],p=e[12],v=e[13],g=e[14],x=e[15],b=t[0],y=t[1],T=t[2],R=t[3];return r[0]=b*i+y*a+T*f+R*p,r[1]=b*n+y*l+T*c+R*v,r[2]=b*o+y*h+T*d+R*g,r[3]=b*s+y*u+T*m+R*x,b=t[4],y=t[5],T=t[6],R=t[7],r[4]=b*i+y*a+T*f+R*p,r[5]=b*n+y*l+T*c+R*v,r[6]=b*o+y*h+T*d+R*g,r[7]=b*s+y*u+T*m+R*x,b=t[8],y=t[9],T=t[10],R=t[11],r[8]=b*i+y*a+T*f+R*p,r[9]=b*n+y*l+T*c+R*v,r[10]=b*o+y*h+T*d+R*g,r[11]=b*s+y*u+T*m+R*x,b=t[12],y=t[13],T=t[14],R=t[15],r[12]=b*i+y*a+T*f+R*p,r[13]=b*n+y*l+T*c+R*v,r[14]=b*o+y*h+T*d+R*g,r[15]=b*s+y*u+T*m+R*x,r},n.multiplyVec3=function(e,t,r){r||(r=t);var i=t[0],n=t[1],o=t[2];return r[0]=e[0]*i+e[4]*n+e[8]*o+e[12],r[1]=e[1]*i+e[5]*n+e[9]*o+e[13],r[2]=e[2]*i+e[6]*n+e[10]*o+e[14],r},n.multiplyVec4=function(e,t,r){r||(r=t);var i=t[0],n=t[1],o=t[2],s=t[3];return r[0]=e[0]*i+e[4]*n+e[8]*o+e[12]*s,r[1]=e[1]*i+e[5]*n+e[9]*o+e[13]*s,r[2]=e[2]*i+e[6]*n+e[10]*o+e[14]*s,r[3]=e[3]*i+e[7]*n+e[11]*o+e[15]*s,r},n.project=function(e,t,r){r||(r=t),n.multiplyVec4(e,t,r);var i=1/r[3];return r[0]*=i,r[1]*=i,r[2]*=i,r},n.rotateVec3=function(e,t,r){r||(r=t);var i=t[0],n=t[1],o=t[2];return r[0]=e[0]*i+e[4]*n+e[8]*o,r[1]=e[1]*i+e[5]*n+e[9]*o,r[2]=e[2]*i+e[6]*n+e[10]*o,r},n.translate=function(e,t,r){var i,n,o,s,a,l,h,u,f,c,d,m,p=t[0],v=t[1],g=t[2];return r&&e!==r?(i=e[0],n=e[1],o=e[2],s=e[3],a=e[4],l=e[5],h=e[6],u=e[7],f=e[8],c=e[9],d=e[10],m=e[11],r[0]=i,r[1]=n,r[2]=o,r[3]=s,r[4]=a,r[5]=l,r[6]=h,r[7]=u,r[8]=f,r[9]=c,r[10]=d,r[11]=m,r[12]=i*p+a*v+f*g+e[12],r[13]=n*p+l*v+c*g+e[13],r[14]=o*p+h*v+d*g+e[14],r[15]=s*p+u*v+m*g+e[15],r):(e[12]=e[0]*p+e[4]*v+e[8]*g+e[12],e[13]=e[1]*p+e[5]*v+e[9]*g+e[13],e[14]=e[2]*p+e[6]*v+e[10]*g+e[14],e[15]=e[3]*p+e[7]*v+e[11]*g+e[15],e)},n.scale=function(e,t,r){var i=t[0],n=t[1],o=t[2];return r&&e!==r?(r[0]=e[0]*i,r[1]=e[1]*i,r[2]=e[2]*i,r[3]=e[3]*i,r[4]=e[4]*n,r[5]=e[5]*n,r[6]=e[6]*n,r[7]=e[7]*n,r[8]=e[8]*o,r[9]=e[9]*o,r[10]=e[10]*o,r[11]=e[11]*o,r[12]=e[12],r[13]=e[13],r[14]=e[14],r[15]=e[15],r):(e[0]*=i,e[1]*=i,e[2]*=i,e[3]*=i,e[4]*=n,e[5]*=n,e[6]*=n,e[7]*=n,e[8]*=o,e[9]*=o,e[10]*=o,e[11]*=o,e)},n.rotate=function(e,t,r,i){var n,o,s,a,l,h,u,f,c,d,m,p,v,g,x,b,y,T,R,_,E,M,A,C,F=r[0],I=r[1],S=r[2],w=Math.sqrt(F*F+I*I+S*S);return w?(1!==w&&(w=1/w,F*=w,I*=w,S*=w),n=Math.sin(t),o=Math.cos(t),s=1-o,a=e[0],l=e[1],h=e[2],u=e[3],f=e[4],c=e[5],d=e[6],m=e[7],p=e[8],v=e[9],g=e[10],x=e[11],b=F*F*s+o,y=I*F*s+S*n,T=S*F*s-I*n,R=F*I*s-S*n,_=I*I*s+o,E=S*I*s+F*n,M=F*S*s+I*n,A=I*S*s-F*n,C=S*S*s+o,i?e!==i&&(i[12]=e[12],i[13]=e[13],i[14]=e[14],i[15]=e[15]):i=e,i[0]=a*b+f*y+p*T,i[1]=l*b+c*y+v*T,i[2]=h*b+d*y+g*T,i[3]=u*b+m*y+x*T,i[4]=a*R+f*_+p*E,i[5]=l*R+c*_+v*E,i[6]=h*R+d*_+g*E,i[7]=u*R+m*_+x*E,i[8]=a*M+f*A+p*C,i[9]=l*M+c*A+v*C,i[10]=h*M+d*A+g*C,i[11]=u*M+m*A+x*C,i):null},n.rotateX=function(e,t,r){var i=Math.sin(t),n=Math.cos(t),o=e[4],s=e[5],a=e[6],l=e[7],h=e[8],u=e[9],f=e[10],c=e[11];return r?e!==r&&(r[0]=e[0],r[1]=e[1],r[2]=e[2],r[3]=e[3],r[12]=e[12],r[13]=e[13],r[14]=e[14],r[15]=e[15]):r=e,r[4]=o*n+h*i,r[5]=s*n+u*i,r[6]=a*n+f*i,r[7]=l*n+c*i,r[8]=o*-i+h*n,r[9]=s*-i+u*n,r[10]=a*-i+f*n,r[11]=l*-i+c*n,r},n.rotateY=function(e,t,r){var i=Math.sin(t),n=Math.cos(t),o=e[0],s=e[1],a=e[2],l=e[3],h=e[8],u=e[9],f=e[10],c=e[11];return r?e!==r&&(r[4]=e[4],r[5]=e[5],r[6]=e[6],r[7]=e[7],r[12]=e[12],r[13]=e[13],r[14]=e[14],r[15]=e[15]):r=e,r[0]=o*n+h*-i,r[1]=s*n+u*-i,r[2]=a*n+f*-i,r[3]=l*n+c*-i,r[8]=o*i+h*n,r[9]=s*i+u*n,r[10]=a*i+f*n,r[11]=l*i+c*n,r},n.rotateZ=function(e,t,r){var i=Math.sin(t),n=Math.cos(t),o=e[0],s=e[1],a=e[2],l=e[3],h=e[4],u=e[5],f=e[6],c=e[7];return r?e!==r&&(r[8]=e[8],r[9]=e[9],r[10]=e[10],r[11]=e[11],r[12]=e[12],r[13]=e[13],r[14]=e[14],r[15]=e[15]):r=e,r[0]=o*n+h*i,r[1]=s*n+u*i,r[2]=a*n+f*i,r[3]=l*n+c*i,r[4]=o*-i+h*n,r[5]=s*-i+u*n,r[6]=a*-i+f*n,r[7]=l*-i+c*n,r},n.frustum=function(e,t,r,i,o,s,a){a||(a=n.create());var l=t-e,h=i-r,u=s-o;return a[0]=2*o/l,a[1]=0,a[2]=0,a[3]=0,a[4]=0,a[5]=2*o/h,a[6]=0,a[7]=0,a[8]=(t+e)/l,a[9]=(i+r)/h,a[10]=-(s+o)/u,a[11]=-1,a[12]=0,a[13]=0,a[14]=-(2*s*o)/u,a[15]=0,a},n.perspective=function(e,t,r,i,o){var s=r*Math.tan(e*Math.PI/360),a=s*t;return n.frustum(-a,a,-s,s,r,i,o)},n.ortho=function(e,t,r,i,o,s,a){a||(a=n.create());var l=t-e,h=i-r,u=s-o;return a[0]=2/l,a[1]=0,a[2]=0,a[3]=0,a[4]=0,a[5]=2/h,a[6]=0,a[7]=0,a[8]=0,a[9]=0,a[10]=-2/u,a[11]=0,a[12]=-(e+t)/l,a[13]=-(i+r)/h,a[14]=-(s+o)/u,a[15]=1,a},n.lookAt=function(e,t,r,i){i||(i=n.create());var o,s,a,l,h,u,f,c,d,m,p=e[0],v=e[1],g=e[2],x=r[0],b=r[1],y=r[2],T=t[0],R=t[1],_=t[2];return p===T&&v===R&&g===_?n.identity(i):(f=p-T,c=v-R,d=g-_,m=1/Math.sqrt(f*f+c*c+d*d),f*=m,c*=m,d*=m,o=b*d-y*c,s=y*f-x*d,a=x*c-b*f,m=Math.sqrt(o*o+s*s+a*a),m?(m=1/m,o*=m,s*=m,a*=m):(o=0,s=0,a=0),l=c*a-d*s,h=d*o-f*a,u=f*s-c*o,m=Math.sqrt(l*l+h*h+u*u),m?(m=1/m,l*=m,h*=m,u*=m):(l=0,h=0,u=0),i[0]=o,i[1]=l,i[2]=f,i[3]=0,i[4]=s,i[5]=h,i[6]=c,i[7]=0,i[8]=a,i[9]=u,i[10]=d,i[11]=0,i[12]=-(o*p+s*v+a*g),i[13]=-(l*p+h*v+u*g),i[14]=-(f*p+c*v+d*g),i[15]=1,i)},n.str=function(e){return"["+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+", "+e[4]+", "+e[5]+", "+e[6]+", "+e[7]+", "+e[8]+", "+e[9]+", "+e[10]+", "+e[11]+", "+e[12]+", "+e[13]+", "+e[14]+", "+e[15]+"]"};var o={};o.create=function(e){var t=new r(4);return e?(t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3]):t[0]=t[1]=t[2]=t[3]=0,t},o.createFrom=function(e,t,i,n){var o=new r(4);return o[0]=e,o[1]=t,o[2]=i,o[3]=n,o},o.set=function(e,t){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t},o.equal=function(e,r){return e===r||t>Math.abs(e[0]-r[0])&&t>Math.abs(e[1]-r[1])&&t>Math.abs(e[2]-r[2])&&t>Math.abs(e[3]-r[3])},o.identity=function(e){return e||(e=o.create()),e[0]=0,e[1]=0,e[2]=0,e[3]=1,e},o.identity(),o.calculateW=function(e,t){var r=e[0],i=e[1],n=e[2];return t&&e!==t?(t[0]=r,t[1]=i,t[2]=n,t[3]=-Math.sqrt(Math.abs(1-r*r-i*i-n*n)),t):(e[3]=-Math.sqrt(Math.abs(1-r*r-i*i-n*n)),e)},o.dot=function(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]+e[3]*t[3]},o.inverse=function(e,t){var r=e[0],i=e[1],n=e[2],o=e[3],s=r*r+i*i+n*n+o*o,a=s?1/s:0;return t&&e!==t?(t[0]=-e[0]*a,t[1]=-e[1]*a,t[2]=-e[2]*a,t[3]=e[3]*a,t):(e[0]*=-a,e[1]*=-a,e[2]*=-a,e[3]*=a,e)},o.conjugate=function(e,t){return t&&e!==t?(t[0]=-e[0],t[1]=-e[1],t[2]=-e[2],t[3]=e[3],t):(e[0]*=-1,e[1]*=-1,e[2]*=-1,e)},o.length=function(e){var t=e[0],r=e[1],i=e[2],n=e[3];return Math.sqrt(t*t+r*r+i*i+n*n)},o.normalize=function(e,t){t||(t=e);var r=e[0],i=e[1],n=e[2],o=e[3],s=Math.sqrt(r*r+i*i+n*n+o*o);return 0===s?(t[0]=0,t[1]=0,t[2]=0,t[3]=0,t):(s=1/s,t[0]=r*s,t[1]=i*s,t[2]=n*s,t[3]=o*s,t)},o.add=function(e,t,r){return r&&e!==r?(r[0]=e[0]+t[0],r[1]=e[1]+t[1],r[2]=e[2]+t[2],r[3]=e[3]+t[3],r):(e[0]+=t[0],e[1]+=t[1],e[2]+=t[2],e[3]+=t[3],e)},o.multiply=function(e,t,r){r||(r=e);var i=e[0],n=e[1],o=e[2],s=e[3],a=t[0],l=t[1],h=t[2],u=t[3];return r[0]=i*u+s*a+n*h-o*l,r[1]=n*u+s*l+o*a-i*h,r[2]=o*u+s*h+i*l-n*a,r[3]=s*u-i*a-n*l-o*h,r},o.multiplyVec3=function(e,t,r){r||(r=t);var i=t[0],n=t[1],o=t[2],s=e[0],a=e[1],l=e[2],h=e[3],u=h*i+a*o-l*n,f=h*n+l*i-s*o,c=h*o+s*n-a*i,d=-s*i-a*n-l*o;return r[0]=u*h+d*-s+f*-l-c*-a,r[1]=f*h+d*-a+c*-s-u*-l,r[2]=c*h+d*-l+u*-a-f*-s,r},o.scale=function(e,t,r){return r&&e!==r?(r[0]=e[0]*t,r[1]=e[1]*t,r[2]=e[2]*t,r[3]=e[3]*t,r):(e[0]*=t,e[1]*=t,e[2]*=t,e[3]*=t,e)},o.toMat4=function(e,t){t||(t=n.create());var r=e[0],i=e[1],o=e[2],s=e[3],a=r+r,l=i+i,h=o+o,u=r*a,f=r*l,c=r*h,d=i*l,m=i*h,p=o*h,v=s*a,g=s*l,x=s*h;return t[0]=1-(d+p),t[1]=f+x,t[2]=c-g,t[3]=0,t[4]=f-x,t[5]=1-(u+p),t[6]=m+v,t[7]=0,t[8]=c+g,t[9]=m-v,t[10]=1-(u+d),t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t},o.slerp=function(e,t,r,i){i||(i=e);var n,o,s,a,l=e[0]*t[0]+e[1]*t[1]+e[2]*t[2]+e[3]*t[3];return Math.abs(l)>=1?(i!==e&&(i[0]=e[0],i[1]=e[1],i[2]=e[2],i[3]=e[3]),i):(n=Math.acos(l),o=Math.sqrt(1-l*l),.001>Math.abs(o)?(i[0]=.5*e[0]+.5*t[0],i[1]=.5*e[1]+.5*t[1],i[2]=.5*e[2]+.5*t[2],i[3]=.5*e[3]+.5*t[3],i):(s=Math.sin((1-r)*n)/o,a=Math.sin(r*n)/o,i[0]=e[0]*s+t[0]*a,i[1]=e[1]*s+t[1]*a,i[2]=e[2]*s+t[2]*a,i[3]=e[3]*s+t[3]*a,i))},o.fromRotationMatrix=function(e,t){t||(t=o.create());var r,i=e[0]+e[4]+e[8];if(i>0)r=Math.sqrt(i+1),t[3]=.5*r,r=.5/r,t[0]=(e[7]-e[5])*r,t[1]=(e[2]-e[6])*r,t[2]=(e[3]-e[1])*r;else{var n=o.fromRotationMatrix.s_iNext=o.fromRotationMatrix.s_iNext||[1,2,0],s=0;e[4]>e[0]&&(s=1),e[8]>e[3*s+s]&&(s=2);var a=n[s],l=n[a];r=Math.sqrt(e[3*s+s]-e[3*a+a]-e[3*l+l]+1),t[s]=.5*r,r=.5/r,t[3]=(e[3*l+a]-e[3*a+l])*r,t[a]=(e[3*a+s]+e[3*s+a])*r,t[l]=(e[3*l+s]+e[3*s+l])*r}return t},o.identity=function(e){return e||(e=o.create()),e[0]=0,e[1]=0,e[2]=0,e[3]=1,e},o.fromAngleAxis=function(e,t,r){r||(r=o.create());var i=.5*e,n=Math.sin(i);return r[3]=Math.cos(i),r[0]=n*t[0],r[1]=n*t[1],r[2]=n*t[2],r},o.toAngleAxis=function(e,t){t||(t=e);var r=e[0]*e[0]+e[1]*e[1]+e[2]*e[2];if(r>0){t[3]=2*Math.acos(e[3]);var i=1/Math.sqrt(r);t[0]=e[0]*i,t[1]=e[1]*i,t[2]=e[2]*i}else t[3]=0,t[0]=1,t[1]=0,t[2]=0;return t},o.str=function(e){return"["+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+"]"},e.vec3=i,e.mat4=n,e.quat4=o}(window),r("glMatrix",function(){}),r("Frustum",["./glMatrix"],function(){var e=function(){this.normal=vec3.create([0,0,0]),this.d=0};e.prototype.init=function(e,t,r){var i=[],n=[];vec3.subtract(t,e,i),vec3.subtract(r,e,n),vec3.cross(i,n,this.normal),vec3.normalize(this.normal),this.d=-vec3.dot(e,this.normal)},e.prototype.transform=function(e){var t=[this.normal[0],this.normal[1],this.normal[2],this.d];mat4.multiplyVec4(e,t),this.normal[0]=t[0],this.normal[1]=t[1],this.normal[2]=t[2],this.d=t[3]},e.prototype.intersectSphere=function(e,t){var r=vec3.dot(e,this.normal)+this.d;return r>t?1:-t>r?-1:0},e.prototype.distance=function(e){return e[0]*this.normal[0]+e[1]*this.normal[1]+e[2]*this.normal[2]+this.d},e.prototype.intersectBoundingBox=function(e){var t=(this.normal[0]>=0?1:0)|(this.normal[1]>=0?2:0)|(this.normal[2]>=0?4:0),r=7&~t;return this.distance(e.getCorner(r))>0?1:0>this.distance(e.getCorner(t))?-1:0};var t=function(){this.planes=[new e,new e,new e,new e,new e]};return t.prototype.compute=function(e){var t=mat4.create();mat4.inverse(e,t);var r=mat4.project(t,[-1,-1,-1,1]),i=mat4.project(t,[-1,1,-1,1]),n=mat4.project(t,[1,1,-1,1]),o=mat4.project(t,[1,-1,-1,1]);this.planes[0].init([0,0,0],r,i),this.planes[1].init([0,0,0],i,n),this.planes[2].init([0,0,0],n,o),this.planes[3].init([0,0,0],o,r),this.planes[4].init(r,i,n)},t.prototype.transform=function(e,t){var r=mat4.create();mat4.inverse(t,r),this.inverseTransform(e,r)},t.prototype.inverseTransform=function(e,t){for(var r=0;e.planes.length>r;r++){var i=e.planes[r],n=i.normal[0],o=i.normal[1],s=i.normal[2],a=i.d;i=this.planes[r],i.normal[0]=t[0]*n+t[1]*o+t[2]*s+t[3]*a,i.normal[1]=t[4]*n+t[5]*o+t[6]*s+t[7]*a,i.normal[2]=t[8]*n+t[9]*o+t[10]*s+t[11]*a,i.d=t[12]*n+t[13]*o+t[14]*s+t[15]*a}},t.prototype.containsSphere=function(e,t){for(var r=1,i=0;this.planes.length>i;i++){var n=this.planes[i].normal,o=e[0]*n[0]+e[1]*n[1]+e[2]*n[2]+this.planes[i].d;if(t>=o){if(-t>o)return-1;r=0}}return r},t.prototype.containsBoundingBox=function(e){for(var t=0;this.planes.length>t;t++){var r=this.planes[t],i=r.normal[0]>=0?e.max[0]:e.min[0],n=r.normal[1]>=0?e.max[1]:e.min[1],o=r.normal[2]>=0?e.max[2]:e.min[2],s=i*r.normal[0]+n*r.normal[1]+o*r.normal[2]+r.d;if(0>s)return!1}return!0},t}),r("RenderContext",["./Frustum","./Numeric","./CoordinateSystem","./glMatrix"],function(e,t,r){var i=function(t){this.shadersPath=t.shadersPath||"../shaders/",this.tileErrorTreshold=t.tileErrorTreshold||4,this.lighting=t.lighting||!1,this.continuousRendering=t.continuousRendering||!1,this.stats=null;var r=null;if(!t.canvas)throw"GlobWeb : no canvas in options";if(r="string"==typeof t.canvas?document.getElementById(t.canvas):t.canvas,!r instanceof HTMLCanvasElement)throw"GlobWeb : invalid canvas";for(var n=["webgl","experimental-webgl","webkit-3d","moz-webgl"],o=null,s=0;n.length>s&&null==o;++s)try{o=r.getContext(n[s],t.contextAttribs)}catch(a){}if(null==o)throw"GlobWeb : WebGL context cannot be initialized";if(t.backgroundColor){var l=t.backgroundColor;o.clearColor(l[0],l[1],l[2],l[3])}else o.clearColor(0,0,0,1);o.pixelStorei(o.UNPACK_COLORSPACE_CONVERSION_WEBGL,o.NONE),o.enable(o.DEPTH_TEST),o.enable(o.CULL_FACE),this.viewMatrix=mat4.create(),this.modelViewMatrix=mat4.create(),this.projectionMatrix=mat4.create(),this.gl=o,this.canvas=r,this.frustum=new e,this.worldFrustum=new e,this.localFrustum=new e,this.eyePosition=vec3.create(),this.eyeDirection=vec3.create(),this.minNear=1e-5,this.near=i.minNear,this.far=6,this.numActiveAttribArray=0,this.frameRequested=!1,this.fov=45,window.requestAnimationFrame||(window.requestAnimationFrame=function(){return window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(e){window.setTimeout(e,1e3/60)}}())};return i.prototype.requestFrame=function(){this.frameRequested||(window.requestAnimationFrame(this.frame),this.frameRequested=!0)},i.prototype.updateViewDependentProperties=function(){var e=mat4.create();mat4.inverse(this.viewMatrix,e),vec3.set([0,0,0],this.eyePosition),mat4.multiplyVec3(e,this.eyePosition),vec3.set([0,0,-1],this.eyeDirection),mat4.rotateVec3(e,this.eyeDirection),this.pixelSizeVector=this.computePixelSizeVector(),mat4.perspective(this.fov,this.canvas.width/this.canvas.height,this.minNear,this.far,this.projectionMatrix),this.frustum.compute(this.projectionMatrix),this.worldFrustum.inverseTransform(this.frustum,this.viewMatrix),this.near=1e9,this.far=0},i.prototype.getXYRelativeToCanvas=function(e){var t=[];e.pageX||e.pageY?(t[0]=e.pageX,t[1]=e.pageY):(t[0]=e.clientX+document.body.scrollLeft+document.documentElement.scrollLeft,t[1]=e.clientY+document.body.scrollTop+document.documentElement.scrollTop);for(var r=this.canvas;r;)t[0]-=r.offsetLeft,t[1]-=r.offsetTop,r=r.offsetParent;return t},i.prototype.computePixelSizeVector=function(e){var t=this.canvas.width,r=this.canvas.height,i=this.projectionMatrix,n=e||this.viewMatrix,o=.5*i[0]*t,s=.5*i[8]*t+.5*i[11]*t,a=[n[0]*o+n[2]*s,n[4]*o+n[6]*s,n[8]*o+n[10]*s],l=.5*i[5]*r,h=.5*i[9]*r+.5*i[11]*r,u=[n[1]*l+n[2]*h,n[5]*l+n[6]*h,n[9]*l+n[10]*h],f=i[11],c=i[15],d=[n[2]*f,n[6]*f,n[10]*f,n[14]*f+n[15]*c],m=.7071067811/Math.sqrt(vec3.dot(a,a)+vec3.dot(u,u));return d[0]*=m,d[1]*=m,d[2]*=m,d[3]*=m,d},i.prototype.get3DFromPixel=function(e,i){var n=2*(e/this.canvas.width)-1,o=-(2*(i/this.canvas.height)-1),s=mat4.create();mat4.multiply(this.projectionMatrix,this.viewMatrix,s),mat4.inverse(s);var a=mat4.multiplyVec4(s,[n,o,-1,1]);a[0]/=a[3],a[1]/=a[3],a[2]/=a[3],mat4.inverse(this.viewMatrix,s);var l=[s[12],s[13],s[14]],h=vec3.create();vec3.subtract(a,l,h),vec3.normalize(h);var u=t.raySphereIntersection(l,h,[0,0,0],r.radius);if(u>=0){var f=t.pointOnRay(l,h,u);return f}return null},i.prototype.getPixelFrom3D=function(e,t,r){var i=mat4.create();mat4.multiply(this.projectionMatrix,this.viewMatrix,i);var n=[e,t,r,1];mat4.project(i,n);var o=Math.round(.5*(1+n[0])*this.canvas.width),s=Math.round(.5*(1-n[1])*this.canvas.height);return[o,s]},i.prototype.createNonPowerOfTwoTextureFromImage=function(e){var t=this.gl,r=t.createTexture();return t.bindTexture(t.TEXTURE_2D,r),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,e),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),r},i}),r("BoundingBox",[],function(){var e=function(e,t){e&&(this.min=vec3.create(e)),t&&(this.max=vec3.create(t))};return e.prototype.extend=function(e,t,r){this.min?(this.min[0]>e&&(this.min[0]=e),this.min[1]>t&&(this.min[1]=t),this.min[2]>r&&(this.min[2]=r),e>this.max[0]&&(this.max[0]=e),t>this.max[1]&&(this.max[1]=t),r>this.max[2]&&(this.max[2]=r)):(this.min=vec3.create(),this.max=vec3.create(),this.min[0]=e,this.min[1]=t,this.min[2]=r,this.max[0]=e,this.max[1]=t,this.max[2]=r)},e.prototype.compute=function(e,t,r){this.min||(this.min=vec3.create(),this.max=vec3.create()),this.min[0]=e[0],this.min[1]=e[1],this.min[2]=e[2],this.max[0]=e[0],this.max[1]=e[1],this.max[2]=e[2];for(var i=r||3,n=t||e.length,o=r;n>o;o+=i)for(var s=0;3>s;s++)e[o+s]<this.min[s]&&(this.min[s]=e[o+s]),e[o+s]>this.max[s]&&(this.max[s]=e[o+s])},e.prototype.getCorner=function(e){return[1&e?this.max[0]:this.min[0],2&e?this.max[1]:this.min[1],4&e?this.max[2]:this.min[2]]},e.prototype.getCenter=function(){return[.5*(this.max[0]+this.min[0]),.5*(this.max[1]+this.min[1]),.5*(this.max[2]+this.min[2])]},e.prototype.getRadius=function(){var e=vec3.create();return vec3.subtract(this.max,this.min,e),.5*vec3.length(e)},e}),r("Tile",["./BoundingBox","./CoordinateSystem","./glMatrix"],function(e,t){var r=function(){this.parent=null,this.parentIndex=-1,this.children=null,this.vertices=null,this.texture=null,this.vertexBuffer=null,this.texTransform=[1,1,0,0],this.matrix=null,this.inverseMatrix=null,this.bbox=new e,this.radius=0,this.distance=0,this.closestPointToEye=[0,0,0],this.extension={},this.state=r.State.NONE,this.config=null};return r.State={ERROR:-10,NONE:0,REQUESTED:1,LOADING:2,LOADED:3},r.prototype.computePosition=function(e,t){for(var r=Math.floor(t),i=t-r,n=Math.floor(e),o=e-n,s=this.config.tesselation,a=this.config.vertexSize,l=a*(r*s+n),h=[0,0,0],u=0;3>u;u++)h[u]=(1-i)*(1-o)*this.vertices[l+u]+i*(1-o)*this.vertices[l+a*s+u]+i*o*this.vertices[l+a*s+a+u]+(1-i)*o*this.vertices[l+a+u];return h},r.prototype.initFromParent=function(e,t,r){this.parent=e,this.parentIndex=2*r+t,this.matrix=e.matrix,this.inverseMatrix=e.inverseMatrix,this.texture=e.texture,this.config=e.config,this.vertexBuffer=e.vertexBuffer;for(var i=this.config.tesselation,n=(i-1)/2,o=0;n>=o;o++)for(var s=this.config.vertexSize*((o+r*n)*i+t*n),a=0;n>=a;a++)this.bbox.extend(e.vertices[s],e.vertices[s+1],e.vertices[s+2]),s+=this.config.vertexSize;this.radius=this.bbox.getRadius()},r.prototype.needsToBeRefined=function(e){if(this.distance<this.radius)return!0;var t=.25*(this.bbox.max[0]-this.bbox.min[0]+(this.bbox.max[1]-this.bbox.min[1]))/this.config.imageSize,r=this.matrix,i=this.closestPointToEye,n=r[0]*i[0]+r[4]*i[1]+r[8]*i[2]+r[12],o=r[1]*i[0]+r[5]*i[1]+r[9]*i[2]+r[13],s=r[2]*i[0]+r[6]*i[1]+r[10]*i[2]+r[14],a=e.pixelSizeVector,l=t/(n*a[0]+o*a[1]+s*a[2]+a[3]);return l>e.tileErrorTreshold},r.prototype.isCulled=function(e){var r=this.inverseMatrix,i=e.eyePosition,n=r[0]*i[0]+r[4]*i[1]+r[8]*i[2]+r[12],o=r[1]*i[0]+r[5]*i[1]+r[9]*i[2]+r[13],s=r[2]*i[0]+r[6]*i[1]+r[10]*i[2]+r[14];if(this.distance=Math.sqrt(n*n+o*o+s*s),this.distance<this.radius)return this.distance=0,!1;var a=this.closestPointToEye;if(a[0]=Math.min(Math.max(n,this.bbox.min[0]),this.bbox.max[0]),a[1]=Math.min(Math.max(o,this.bbox.min[1]),this.bbox.max[1]),a[2]=Math.min(Math.max(s,this.bbox.min[2]),this.bbox.max[2]),0>s){var l=a[0],h=a[1],u=a[2]+t.radius,f=Math.sqrt(l*l+h*h+u*u);l/=f,h/=f,u/=f;var c=n-l*t.radius,d=o-h*t.radius,m=s-(u-1)*t.radius,p=Math.sqrt(c*c+d*d+m*m),v=(c*l+d*h+m*u)/p;if(v*=this.config.cullSign,-.05>v)return!0}var g=e.localFrustum;return g.inverseTransform(e.worldFrustum,this.matrix),!g.containsBoundingBox(this.bbox)},r.prototype.dispose=function(e,t){if(this.state==r.State.LOADED){t.disposeGLBuffer(this.vertexBuffer),t.disposeGLTexture(this.texture);for(var i in this.extension)this.extension[i].dispose&&this.extension[i].dispose(e,t);this.vertexBuffer=null,this.texture=null,this.parent=null,this.state=r.State.NONE}},r.prototype.deleteChildren=function(e,t){if(this.children){for(var r=0;4>r;r++)this.children[r].dispose(e,t),this.children[r].deleteChildren(e,t);this.children=null}},r.prototype.buildSkirtVertices=function(e,t,r,i){for(var n=this.vertices,o=.05*this.radius,s=this.config.tesselation,a=0;s>a;a++){var l=n[t]-e[0],h=n[t+1]-e[1],u=n[t+2]-e[2],f=o/Math.sqrt(l*l+h*h+u*u);l*=f,h*=f,u*=f,n[i]=n[t]-l,n[i+1]=n[t+1]-h,n[i+2]=n[t+2]-u;for(var c=3;this.config.vertexSize>c;c++)n[i+c]=n[t+c];i+=this.config.vertexSize,t+=r}},r.prototype.generateNormals=function(){for(var e=this.config.tesselation,t=this.config.vertexSize,r=t*e,i=0,n=0;e>n;n++)for(var o=n==e-1?0:r,s=0==n?0:-r,a=0;e>a;a++){var l=a==e-1?0:t,h=0==a?0:-t,u=[this.vertices[i+l]-this.vertices[i+h],this.vertices[i+l+1]-this.vertices[i+h+1],this.vertices[i+l+2]-this.vertices[i+h+2]],f=[this.vertices[i+o]-this.vertices[i+s],this.vertices[i+o+1]-this.vertices[i+s+1],this.vertices[i+o+2]-this.vertices[i+s+2]],c=vec3.cross(u,f,[]);vec3.normalize(c),this.vertices[i+3]=c[0],this.vertices[i+4]=c[1],this.vertices[i+5]=c[2],i+=t}},r.prototype.generate=function(e,t,i){this.vertices=this.generateVertices(i);var n=this.config.tesselation,o=this.config.vertexSize;if(this.bbox.compute(this.vertices,o*n*n,o),this.radius=this.bbox.getRadius(),this.config.normals&&this.generateNormals(),this.config.skirt){var s=[0,0,0];mat4.multiplyVec3(this.inverseMatrix,s);var a=o*n*n;this.buildSkirtVertices(s,0,o,a),a+=o*n,this.buildSkirtVertices(s,o*n*(n-1),o,a),a+=o*n,this.buildSkirtVertices(s,0,o*n,a),a+=o*n,this.buildSkirtVertices(s,o*(n-1),o*n,a),a+=o*n,this.buildSkirtVertices(s,o*(n*(n-1)/2),o,a),a+=o*n,this.buildSkirtVertices(s,o*((n-1)/2),o*n,a)}null!=this.vertexBuffer&&null==this.parent&&e.disposeGLBuffer(this.vertexBuffer),this.vertexBuffer=e.createGLBuffer(this.vertices),t&&(this.texture=e.createGLTexture(t)),this.state=r.State.LOADED},r}),r("TilePool",[],function(){var e=function(e){var t=e.gl,r=[],i=[],n=this;this.numCreatedTextures=0,this.numReusedTextures=0;var o=function(e){var r=t.createTexture();return t.bindTexture(t.TEXTURE_2D,r),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,e),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR_MIPMAP_LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.generateMipmap(t.TEXTURE_2D),n.numCreatedTextures++,r},s=function(e){var i=r.pop();return t.bindTexture(t.TEXTURE_2D,i),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,e),t.generateMipmap(t.TEXTURE_2D),n.numReusedTextures++,i
};this.createGLTexture=function(e){return r.length>0?s(e):o(e)},this.createGLBuffer=function(e){var r;return r=i.length>0?i.pop():t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,r),t.bufferData(t.ARRAY_BUFFER,e,t.STATIC_DRAW),r},this.disposeGLTexture=function(e){r.push(e)},this.disposeGLBuffer=function(e){i.push(e)},this.disposeAll=function(){for(var e=0;r.length>e;e++)t.deleteTexture(r[e]);r.length=0;for(var e=0;i.length>e;e++)t.deleteBuffer(i[e]);i.length=0}};return e}),r("TileRequest",["./Tile"],function(e){var t=function(e){this.tile=null,this.imageLoaded=!1,this.elevationLoaded=!0,this.tileManager=e;var t=this;this.image=new Image,this.image.crossOrigin="",this.image.onload=function(){t.handleLoadedImage()},this.image.onerror=function(){t.handleErrorImage()},this.image.onabort=function(){t.handleAbort()},this.xhr=new XMLHttpRequest,this.xhr.onreadystatechange=function(){4==t.xhr.readyState&&(200==t.xhr.status?t.handleLoadedElevation():t.handleErrorElevation())}};return t.prototype.handleLoadedImage=function(){this.imageLoaded=!0,this.elevationLoaded&&(this.tileManager.completedRequests.push(this),this.tileManager.renderContext.requestFrame())},t.prototype.handleErrorImage=function(){console.log("Error while loading "+this.image.src),this.tile.state=e.State.ERROR,this.tileManager.availableRequests.push(this)},t.prototype.handleAbort=function(){this.tile.state=e.State.NONE,this.tileManager.availableRequests.push(this)},t.prototype.handleLoadedElevation=function(){this.elevations=this.xhr.responseText,this.elevationLoaded=!0,this.imageLoaded&&(this.tileManager.completedRequests.push(this),this.tileManager.renderContext.requestFrame())},t.prototype.handleErrorElevation=function(){this.elevations=null,this.elevationLoaded=!0,this.imageLoaded&&(this.tileManager.completedRequests.push(this),this.tileManager.renderContext.requestFrame())},t.prototype.launch=function(e){this.tile=e,this.tileManager.elevationProvider?(this.elevationLoaded=!1,this.xhr.open("GET",this.tileManager.elevationProvider.getUrl(e)),this.xhr.send()):this.elevationLoaded=!0,this.imageLoaded=!1,this.image.src=this.tileManager.imageryProvider.getUrl(e)},t}),r("TileIndexBuffer",[],function(){var e=function(e,t){this.renderContext=e,this.config=t,this.solidIndexBuffer=null,this.subSolidIndexBuffer=[null,null,null,null],this.subIndices=[null,null,null,null]};return e.prototype.reset=function(){for(var e=this.renderContext.gl,t=0;4>t;t++)this.subSolidIndexBuffer[t]&&(e.deleteBuffer(this.subSolidIndexBuffer[t]),this.subSolidIndexBuffer[t]=null);this.solidIndexBuffer&&(e.deleteBuffer(this.solidIndexBuffer),this.solidIndexBuffer=null)},e.prototype.getSubSolid=function(e){if(null==this.subSolidIndexBuffer[e]){for(var t=e%2,r=Math.floor(e/2),i=this.config.tesselation,n=(i-1)/2,o=[],s=n*r;n*(r+1)>s;s++)for(var a=n*t;n*(t+1)>a;a++)o.push(s*i+a),o.push((s+1)*i+a),o.push(s*i+a+1),o.push(s*i+a+1),o.push((s+1)*i+a),o.push((s+1)*i+a+1);if(this.subIndices[e]=o,this.config.skirt){for(var l=0==r?i*i:i*i+4*i,h=0==r?0:n*i,s=n*t;n*(t+1)>s;s++)o.push(l+s),o.push(h+s),o.push(l+s+1),o.push(l+s+1),o.push(h+s),o.push(h+s+1);l=0==r?i*i+4*i:i*i+i,h=0==r?n*i:(i-1)*i;for(var s=n*t;n*(t+1)>s;s++)o.push(h+s),o.push(l+s),o.push(h+s+1),o.push(h+s+1),o.push(l+s),o.push(l+s+1);l=0==t?i*i+2*i:i*i+5*i,h=0==t?0:n;for(var a=n*r;n*(r+1)>a;a++)o.push(l+a),o.push(l+a+1),o.push(h+a*i),o.push(h+a*i),o.push(l+a+1),o.push(h+(a+1)*i);l=0==t?i*i+5*i:i*i+3*i,h=0==t?n:i-1;for(var a=n*r;n*(r+1)>a;a++)o.push(a*i+h),o.push((a+1)*i+h),o.push(l+a),o.push(l+a),o.push((a+1)*i+h),o.push(l+a+1)}var u=this.renderContext.gl,f=u.createBuffer();u.bindBuffer(u.ELEMENT_ARRAY_BUFFER,f),u.bufferData(u.ELEMENT_ARRAY_BUFFER,new Uint16Array(o),u.STATIC_DRAW),f.numIndices=o.length,this.subSolidIndexBuffer[e]=f}return this.subSolidIndexBuffer[e]},e.prototype.getSolid=function(){if(null==this.solidIndexBuffer){for(var e=this.config.tesselation,t=[],r=0;e-1>r;r++)for(var i=0;e-1>i;i++)t.push(r*e+i),t.push((r+1)*e+i),t.push(r*e+i+1),t.push(r*e+i+1),t.push((r+1)*e+i),t.push((r+1)*e+i+1);if(this.config.skirt){for(var n=e*e,i=0;e-1>i;i++)t.push(n+i),t.push(i),t.push(n+i+1),t.push(n+i+1),t.push(i),t.push(i+1);n+=e;for(var i=0;e-1>i;i++)t.push((e-1)*e+i),t.push(n+i),t.push((e-1)*e+i+1),t.push((e-1)*e+i+1),t.push(n+i),t.push(n+i+1);n+=e;for(var r=0;e-1>r;r++)t.push(n+r),t.push(n+r+1),t.push(r*e),t.push(r*e),t.push(n+r+1),t.push((r+1)*e);n+=e;for(var r=0;e-1>r;r++)t.push(r*e+e-1),t.push((r+1)*e+e-1),t.push(n+r),t.push(n+r),t.push((r+1)*e+e-1),t.push(n+r+1)}var o=this.renderContext.gl,s=o.createBuffer();o.bindBuffer(o.ELEMENT_ARRAY_BUFFER,s),o.bufferData(o.ELEMENT_ARRAY_BUFFER,new Uint16Array(t),o.STATIC_DRAW),this.numIndices=t.length,this.solidIndexBuffer=s,this.solidIndexBuffer.numIndices=t.length}return this.solidIndexBuffer},e}),r("Program",[],function(){var e=function(e){this.renderContext=e,this.glProgram=null,this.attributes={},this.uniforms={},this.numActiveAttribArray=0};return e.prototype.createShader=function(e,t){var r=this.renderContext.gl,i=r.createShader(e);return r.shaderSource(i,t),r.compileShader(i),r.getShaderParameter(i,r.COMPILE_STATUS)?i:(console.log("Shader compilation error: "+r.getShaderInfoLog(i)),console.log(t),r.deleteShader(i),null)},e.prototype.createFromSource=function(e,t){var r=this.renderContext.gl,i=this.createShader(r.VERTEX_SHADER,e),n=this.createShader(r.FRAGMENT_SHADER,t);if(null==i||null==n)return!1;if(this.glProgram=r.createProgram(),r.attachShader(this.glProgram,i),r.attachShader(this.glProgram,n),r.linkProgram(this.glProgram),!r.getProgramParameter(this.glProgram,r.LINK_STATUS))return console.log("Program link error: "+r.getProgramInfoLog(this.glProgram)),r.deleteShader(i),r.deleteShader(n),r.deleteProgram(this.glProgram),this.glProgram=null,!1;var o=r.getProgramParameter(this.glProgram,r.ACTIVE_ATTRIBUTES);this.numActiveAttribArray=0;for(var s=0;o>s;++s){var a=r.getActiveAttrib(this.glProgram,s),l=r.getAttribLocation(this.glProgram,a.name);this.attributes[a.name]=l,l+1>this.numActiveAttribArray&&(this.numActiveAttribArray=l+1)}for(var h=r.getProgramParameter(this.glProgram,r.ACTIVE_UNIFORMS),s=0;h>s;++s){var u=r.getActiveUniform(this.glProgram,s);this.uniforms[u.name]=r.getUniformLocation(this.glProgram,u.name)}return!0},e.prototype.loadFromFile=function(e,t){var r=new XMLHttpRequest;r.open("get",this.renderContext.shadersPath+e,!1),r.send(null);var i=r.responseText;r.open("get",this.renderContext.shadersPath+t,!1),r.send(null);var n=r.responseText;return this.createFromSource(i,n)},e.prototype.apply=function(){var e=this.renderContext,t=e.gl;t.useProgram(this.glProgram);for(var r=e.numActiveAttribArray;this.numActiveAttribArray>r;r++)t.enableVertexAttribArray(r);for(var r=this.numActiveAttribArray;e.numActiveAttribArray>r;r++)t.disableVertexAttribArray(r);e.numActiveAttribArray=this.numActiveAttribArray},e}),r("TileManager",["./Tile","./TilePool","./TileRequest","./TileIndexBuffer","./Program","./CoordinateSystem"],function(e,t,r,i,n,o){var s=function(e){this.globe=e,this.renderContext=this.globe.renderContext,this.tilePool=new t(this.renderContext),this.imageryProvider=null,this.elevationProvider=null,this.tilesToRender=[],this.tilesToRequest=[],this.postRenderers=[],this.level0Tiles=[],this.levelZeroTexture=null,this.maxRequests=4,this.availableRequests=[];for(var o=0;this.maxRequests>o;o++)this.availableRequests[o]=new r(this);this.completedRequests=[],this.level0TilesLoaded=!1,this.tileConfig={tesselation:9,skirt:!0,cullSign:1,imageSize:256,vertexSize:this.renderContext.lighting?6:3,normals:this.renderContext.lighting},this.tcoordBuffer=null,this.tileIndexBuffer=new i(this.renderContext,this.tileConfig),this.identityTextureTransform=[1,1,0,0],this.showWireframe=!1,this.freeze=!1,this.numTilesGenerated=0,this.frameNumber=0;var s="	attribute vec3 vertex;\n	attribute vec2 tcoord;\n	uniform mat4 modelViewMatrix;\n	uniform mat4 projectionMatrix;\n	uniform vec4 texTransform;\n	varying vec2 texCoord;\n";this.renderContext.lighting&&(s+="attribute vec3 normal;\nvarying vec3 color;\n"),s+="	void main(void) \n	{\n		gl_Position = projectionMatrix * modelViewMatrix * vec4(vertex, 1.0);\n",this.renderContext.lighting&&(s+="vec4 vn = modelViewMatrix * vec4(normal,0);\ncolor = max( vec3(-vn[2],-vn[2],-vn[2]), 0.0 );\n"),s+="		texCoord = vec2(tcoord.s * texTransform.x + texTransform.z, tcoord.t * texTransform.y + texTransform.w);\n	}\n	";var a="	precision highp float; \n	varying vec2 texCoord;\n";this.renderContext.lighting&&(a+="varying vec3 color;\n"),a+="	uniform sampler2D colorTexture;\n	void main(void)\n	{\n		gl_FragColor.rgb = texture2D(colorTexture, texCoord).rgb;\n",this.renderContext.lighting&&(a+="gl_FragColor.rgb *= color;\n"),a+="		gl_FragColor.a = 1.0;\n	}\n	",this.program=new n(this.renderContext),this.program.createFromSource(s,a)};s.prototype.addPostRenderer=function(e){this.postRenderers.push(e)},s.prototype.removePostRenderer=function(e){var t=this.postRenderers.indexOf(e);-1!=t&&(e.cleanupTile&&this.visitTiles(function(t){e.cleanupTile(t)}),this.postRenderers.splice(t,1))},s.prototype.setImageryProvider=function(e){this.reset(),this.imageryProvider=e,e&&(this.tileConfig.imageSize=e.tilePixelSize,this.level0Tiles=e.tiling.generateLevelZeroTiles(this.tileConfig,this.tilePool))},s.prototype.setElevationProvider=function(e){this.reset(),this.elevationProvider=e,this.tileConfig.tesselation=e?e.tilePixelSize:9},s.prototype.reset=function(){for(var e=0;this.level0Tiles.length>e;e++)this.level0Tiles[e].deleteChildren(this.renderContext,this.tilePool),this.level0Tiles[e].dispose(this.renderContext,this.tilePool);var t=this.renderContext.gl;this.tileIndexBuffer.reset(),t.deleteBuffer(this.tcoordBuffer),this.tcoordBuffer=null,this.levelZeroTexture=null,this.level0TilesLoaded=!1},s.prototype.visitTiles=function(e){for(var t=this.level0Tiles.concat([]);t.length>0;){var r=t.shift();e(r),r.children&&(t.push(r.children[0]),t.push(r.children[1]),t.push(r.children[2]),t.push(r.children[3]))}},s.prototype.traverseTiles=function(){if(this.tilesToRender.length=0,this.tilesToRequest.length=0,this.numTraversedTiles=0,!this.level0TilesLoaded&&!this.levelZeroTexture){this.level0TilesLoaded=!0;for(var t=0;this.level0Tiles.length>t;t++){var r=this.level0Tiles[t],i=r.state==e.State.LOADED;r.frameNumber=this.frameNumber,this.level0TilesLoaded=this.level0TilesLoaded&&i,i||(r.state==e.State.NONE?(r.state=e.State.REQUESTED,this.tilesToRequest.push(r)):r.state==e.State.ERROR&&(this.globe.publish("baseLayersError"),this.imageryProvider._ready=!1))}this.level0TilesLoaded&&this.globe.publish("baseLayersReady")}if(this.level0TilesLoaded||this.levelZeroTexture)for(var t=0;this.level0Tiles.length>t;t++){var r=this.level0Tiles[t];if(r.isCulled(this.renderContext)){var i=r.state==e.State.LOADED;this.levelZeroTexture&&i&&(this.tilePool.disposeGLTexture(r.texture),r.texture=null,r.state=e.State.NONE),r.deleteChildren(this.renderContext,this.tilePool)}else this.processTile(r,0)}},s.prototype.processTile=function(t,r){if(this.numTraversedTiles++,t.frameNumber=this.frameNumber,t.state==e.State.NONE&&(t.state=e.State.REQUESTED,this.tilesToRequest.push(t)),t.state==e.State.LOADED&&this.imageryProvider.numberOfLevels>r+1&&t.needsToBeRefined(this.renderContext)){null==t.children&&t.createChildren();for(var i=0;4>i;i++)t.children[i].isCulled(this.renderContext)?t.children[i].deleteChildren(this.renderContext,this.tilePool):this.processTile(t.children[i],r+1)}else this.tilesToRender.push(t)},s.prototype.generateReceivedTiles=function(){for(;this.completedRequests.length>0;){var t=this.completedRequests.pop(),r=t.tile;if(r.frameNumber==this.frameNumber){this.elevationProvider?r.generate(this.tilePool,t.image,this.elevationProvider.parseElevations(t.elevations)):r.generate(this.tilePool,t.image);for(var i=0;this.postRenderers.length>i;i++)this.postRenderers[i].generate&&this.postRenderers[i].generate(r);this.numTilesGenerated++,this.renderContext.requestFrame()}else r.state=e.State.NONE;this.availableRequests.push(t)}this.availableRequests.length==this.maxRequests&&this.globe.publish("endBackgroundLoad")},s.prototype.renderTiles=function(){var t=this.renderContext,r=t.gl;r.enable(r.POLYGON_OFFSET_FILL),r.polygonOffset(0,4),r.disable(r.CULL_FACE),this.program.apply();var i,n,s=this.program.attributes;if(0>this.tileConfig.cullSign)i=.2*o.radius,n=1.1*o.radius;else{i=1e9,n=0;for(var a=0;this.tilesToRender.length>a;a++){var l=this.tilesToRender[a];i=Math.min(i,l.distance-2*l.radius),n=Math.max(n,l.distance+2*l.radius)}}t.near=Math.max(t.minNear,Math.min(i,t.near)),t.far=Math.max(n,t.far),mat4.perspective(t.fov,t.canvas.width/t.canvas.height,t.near,t.far,t.projectionMatrix),r.activeTexture(r.TEXTURE0),r.uniformMatrix4fv(this.program.uniforms.projectionMatrix,!1,t.projectionMatrix),r.uniform1i(this.program.uniforms.colorTexture,0),this.tcoordBuffer||this.buildSharedTexCoordBuffer(),r.bindBuffer(r.ARRAY_BUFFER,this.tcoordBuffer),r.vertexAttribPointer(s.tcoord,2,r.FLOAT,!1,0,0);for(var h=null,u=null,a=0;this.tilesToRender.length>a;a++){var f,l=this.tilesToRender[a],c=l.state==e.State.LOADED,d=-1==l.parentIndex;!c&&d?(r.bindTexture(r.TEXTURE_2D,this.levelZeroTexture),f=l.texTransform):(r.bindTexture(r.TEXTURE_2D,l.texture),f=this.identityTextureTransform),u!=f&&(r.uniform4f(this.program.uniforms.texTransform,f[0],f[1],f[2],f[3]),u=f),mat4.multiply(t.viewMatrix,l.matrix,t.modelViewMatrix),r.uniformMatrix4fv(this.program.uniforms.modelViewMatrix,!1,t.modelViewMatrix),r.bindBuffer(r.ARRAY_BUFFER,l.vertexBuffer),r.vertexAttribPointer(s.vertex,3,r.FLOAT,!1,4*this.tileConfig.vertexSize,0),this.tileConfig.normals&&r.vertexAttribPointer(s.normal,3,r.FLOAT,!1,4*this.tileConfig.vertexSize,12);var m=c||d?this.tileIndexBuffer.getSolid():this.tileIndexBuffer.getSubSolid(l.parentIndex);h!=m&&(r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,m),h=m),r.drawElements(r.TRIANGLES,h.numIndices,r.UNSIGNED_SHORT,0)}for(var a=0;this.postRenderers.length>a;a++)this.postRenderers[a].needsOffset&&this.postRenderers[a].render(this.tilesToRender);r.disable(r.POLYGON_OFFSET_FILL);for(var a=0;this.postRenderers.length>a;a++)this.postRenderers[a].needsOffset||this.postRenderers[a].render(this.tilesToRender)};var a=function(e,t){return e.distance-t.distance};return s.prototype.launchRequests=function(){this.tilesToRequest.sort(a);for(var t=this.tilesToRequest.length,r=0;t>r;r++){var i=this.tilesToRequest[r];if(this.availableRequests.length>0){this.availableRequests.length==this.maxRequests&&this.globe.publish("startBackgroundLoad");var n=this.availableRequests.pop();n.launch(i),i.state=e.State.LOADING}else i.state=e.State.NONE}},s.prototype.render=function(){if(null!=this.imageryProvider&&this.imageryProvider._ready){null==this.levelZeroTexture&&this.imageryProvider.levelZeroImage&&(this.levelZeroTexture=this.renderContext.createNonPowerOfTwoTextureFromImage(this.imageryProvider.levelZeroImage),this.globe.publish("baseLayersReady"));var e=this.renderContext.stats;this.freeze||(e&&e.start("traverseTime"),this.traverseTiles(),e&&e.end("traverseTime")),(this.level0TilesLoaded||this.levelZeroTexture)&&(e&&e.start("renderTime"),this.renderTiles(),e&&e.end("renderTime")),e&&e.start("generateTime"),this.generateReceivedTiles(),e&&e.end("generateTime"),e&&e.start("requestTime"),this.launchRequests(),e&&e.end("requestTime"),this.frameNumber++}},s.prototype.getVisibleTile=function(e,t){return this.imageryProvider.tiling.findInsideTile(e,t,this.tilesToRender)},s.prototype.buildSharedTexCoordBuffer=function(){var e=this.tileConfig.tesselation,t=this.tileConfig.skirt,r=2*e*e;t&&(r+=6*2*e);for(var i=new Float32Array(r),n=1/(e-1),o=0,s=0,a=0;e>a;a++){for(var l=0,h=0;e>h;h++)i[o]=l,i[o+1]=s,o+=2,l+=n;s+=n}if(t){l=0,s=0;for(var h=0;e>h;h++)i[o]=l,i[o+1]=s,l+=n,o+=2;l=0,s=1;for(var h=0;e>h;h++)i[o]=l,i[o+1]=s,l+=n,o+=2;l=0,s=0;for(var h=0;e>h;h++)i[o]=l,i[o+1]=s,s+=n,o+=2;l=1,s=0;for(var h=0;e>h;h++)i[o]=l,i[o+1]=s,s+=n,o+=2;l=0,s=.5;for(var h=0;e>h;h++)i[o]=l,i[o+1]=s,l+=n,o+=2;l=.5,s=0;for(var h=0;e>h;h++)i[o]=l,i[o+1]=s,s+=n,o+=2}var u=this.renderContext.gl,f=u.createBuffer();u.bindBuffer(u.ARRAY_BUFFER,f),u.bufferData(u.ARRAY_BUFFER,i,u.STATIC_DRAW),this.tcoordBuffer=f},s}),r("VectorRendererManager",[],function(){var e=function(t){this.globe=t,this.factories=[];for(var r=e.globalFactories,i=0;r.length>i;i++)this.factories.push({id:r[i].id,creator:r[i].creator,canApply:r[i].canApply,instance:null})};return e.globalFactories=[],e.registerRenderer=function(t){e.globalFactories.push(t)},e.prototype.getRenderer=function(e){for(var t=0;this.factories.length>t;t++){var r=this.factories[t];if(r.id==e)return r.instance||(r.instance=r.creator(this.globe),this.globe.tileManager.addPostRenderer(r.instance)),r.instance}return null},e.prototype.addGeometry=function(e,t,r){for(var i=e.type,n=0;this.factories.length>n;n++){var o=this.factories[n];o.canApply(i,r)&&(o.instance||(o.instance=o.creator(this.globe),this.globe.tileManager.addPostRenderer(o.instance)),o.instance.addGeometry(e,t,r))}},e.prototype.removeGeometry=function(e,t){for(var r=0;this.factories.length>r;r++){var i=this.factories[r];i.instance&&i.instance.removeGeometry(e,t)}},e}),r("GeoBound",[],function(){var e=function(e,t,r,i){this.south=t,this.west=e,this.north=i,this.east=r};return e.prototype.getCenter=function(){return[.5*(this.east+this.west),.5*(this.south+this.north),0]},e.prototype.getNorth=function(){return this.north},e.prototype.getSouth=function(){return this.south},e.prototype.getWest=function(){return this.west},e.prototype.getEast=function(){return this.east},e.prototype.computeFromCoordinates=function(e){this.west=e[0][0],this.east=e[0][0],this.south=e[0][1],this.north=e[0][1];for(var t=1;e.length>t;t++)this.west=Math.min(this.west,e[t][0]),this.east=Math.max(this.east,e[t][0]),this.south=Math.min(this.south,e[t][1]),this.north=Math.max(this.north,e[t][1])},e.prototype.intersects=function(e){return this.west>=e.east||this.east<=e.west?!1:this.south>=e.north||this.north<=e.south?!1:!0},e}),r("Globe",["./CoordinateSystem","./RenderContext","./TileManager","./Tile","./VectorRendererManager","./Numeric","./GeoBound"],function(e,t,r,i,n,o,s){var a=function(e){this.renderContext=new t(e),this.tileManager=new r(this),this.vectorRendererManager=new n(this),this.attributionHandler=null,this.activeAnimations=[],this.preRenderers=[],this.nbCreatedLayers=0,this.callbacks={};var i=this;this.renderContext.frame=function(){i.renderContext.frameRequested=!1,i.render(),i.renderContext.continuousRendering?i.renderContext.requestFrame():i.activeAnimations.length>0&&i.renderContext.requestFrame()},this.renderContext.requestFrame()};return a.prototype.dispose=function(){this.tileManager.tilePool.disposeAll(),this.tileManager.reset()},a.prototype.refresh=function(){this.renderContext.requestFrame()},a.prototype.setBaseImagery=function(e){this.tileManager.imageryProvider&&this.removeLayer(this.tileManager.imageryProvider),this.tileManager.setImageryProvider(e),e&&(e._overlay=!1,this.addLayer(e))},a.prototype.setBaseElevation=function(e){this.tileManager.elevationProvider&&this.removeLayer(this.tileManager.elevationProvider),this.tileManager.setElevationProvider(e),e&&(e._overlay=!1,this.addLayer(e))},a.prototype.addLayer=function(e){e.id=this.nbCreatedLayers,e._attach(this),this.renderContext.requestFrame(),this.nbCreatedLayers++},a.prototype.removeLayer=function(e){e._detach(),this.renderContext.requestFrame()},a.prototype.addAnimation=function(e){e.globe=this},a.prototype.removeAnimation=function(e){e.globe=null},a.prototype.getElevation=function(e,t){var r=this.tileManager.imageryProvider.tiling,n=this.tileManager.level0Tiles[r.lonlat2LevelZeroIndex(e,t)];return n.state==i.State.LOADED?n.getElevation(e,t):0},a.prototype.getViewportGeoBound=function(){var t=this.renderContext,r=mat4.create();mat4.inverse(t.viewMatrix,r);var i=[r[12],r[13],r[14]];mat4.multiply(t.projectionMatrix,t.viewMatrix,r),mat4.inverse(r);for(var n=[[-1,-1,1,1],[1,-1,1,1],[-1,1,1,1],[1,1,1,1]],a=vec3.create(),l=[0,0,0],h=0;4>h;h++){mat4.multiplyVec4(r,n[h]),vec3.scale(n[h],1/n[h][3]),vec3.subtract(n[h],i,n[h]),vec3.normalize(n[h]);var u=o.raySphereIntersection(i,n[h],l,e.radius);if(0>u)return null;n[h]=e.from3DToGeo(o.pointOnRay(i,n[h],u,a))}var f=new s;return f.computeFromCoordinates(n),f},a.prototype.getLonLatFromPixel=function(t,r){var i=this.renderContext.get3DFromPixel(t,r);return i?e.from3DToGeo(i):null},a.prototype.getPixelFromLonLat=function(t,r){var i=vec3.create();e.fromGeoTo3D([t,r],i);var n=this.renderContext.getPixelFrom3D(i[0],i[1],i[2]);return n},a.prototype.render=function(){var e=this.renderContext,t=e.stats,r=e.gl;if(t&&t.start("globalRenderTime"),this.activeAnimations.length>0)for(var i=Date.now(),n=0;this.activeAnimations.length>n;n++)this.activeAnimations[n].update(i);if(r.clear(r.COLOR_BUFFER_BIT|r.DEPTH_BUFFER_BIT),0!=e.canvas.width&&0!=e.canvas.height){r.viewport(0,0,e.canvas.width,e.canvas.height),e.updateViewDependentProperties();for(var n=0;this.preRenderers.length>n;n++)this.preRenderers[n].preRender();this.tileManager.render(),0!=this.tileManager.tilesToRender.length&&t&&t.end("globalRenderTime")}},a.prototype.subscribe=function(e,t){this.callbacks[e]?this.callbacks[e].push(t):this.callbacks[e]=[t]},a.prototype.unsubscribe=function(e,t){if(this.callbacks[e]){var r=this.callbacks[e].indexOf(t);-1!=r&&this.callbacks[e].splice(r,1)}},a.prototype.publish=function(e,t){if(this.callbacks[e])for(var r=this.callbacks[e],i=0;r.length>i;i++)r[i](t)},a}),r("Utils",[],function(){var e={};return e.inherits=function(e,t){function r(){}r.prototype=e.prototype,t.prototype=new r,t.prototype.constructor=t},e}),r("BaseLayer",[],function(){var e=function(e){this.globe=null,this.name=e&&e.hasOwnProperty("name")?e.name:"",this.attribution=e&&e.hasOwnProperty("attribution")?e.attribution:"",this.icon=e&&e.hasOwnProperty("icon")?e.icon:"",this.description=e&&e.hasOwnProperty("description")?e.description:"",this._visible=e&&e.hasOwnProperty("visible")?e.visible:!0,this._opacity=e&&e.hasOwnProperty("opacity")?e.opacity:1};return e.prototype._attach=function(e){this.globe=e,this.attribution&&this.globe.attributionHandler&&this.globe.attributionHandler.addAttribution(this)},e.prototype._detach=function(){this.attribution&&this.globe.attributionHandler&&this.globe.attributionHandler.removeAttribution(this),this.globe=null},e.prototype.visible=function(e){return"boolean"==typeof e&&(this._visible=e,this.globe&&this.globe.renderContext.requestFrame()),this._visible},e.prototype.opacity=function(e){return"number"==typeof e&&(this._opacity=e,this.globe&&this.globe.renderContext.requestFrame()),this._opacity},e}),r("FeatureStyle",[],function(){var e={aliceblue:"f0f8ff",antiquewhite:"faebd7",aqua:"00ffff",aquamarine:"7fffd4",azure:"f0ffff",beige:"f5f5dc",bisque:"ffe4c4",black:"000000",blanchedalmond:"ffebcd",blue:"0000ff",blueviolet:"8a2be2",brown:"a52a2a",burlywood:"deb887",cadetblue:"5f9ea0",chartreuse:"7fff00",chocolate:"d2691e",coral:"ff7f50",cornflowerblue:"6495ed",cornsilk:"fff8dc",crimson:"dc143c",cyan:"00ffff",darkblue:"00008b",darkcyan:"008b8b",darkgoldenrod:"b8860b",darkgray:"a9a9a9",darkgreen:"006400",darkkhaki:"bdb76b",darkmagenta:"8b008b",darkolivegreen:"556b2f",darkorange:"ff8c00",darkorchid:"9932cc",darkred:"8b0000",darksalmon:"e9967a",darkseagreen:"8fbc8f",darkslateblue:"483d8b",darkslategray:"2f4f4f",darkturquoise:"00ced1",darkviolet:"9400d3",deeppink:"ff1493",deepskyblue:"00bfff",dimgray:"696969",dodgerblue:"1e90ff",feldspar:"d19275",firebrick:"b22222",floralwhite:"fffaf0",forestgreen:"228b22",fuchsia:"ff00ff",gainsboro:"dcdcdc",ghostwhite:"f8f8ff",gold:"ffd700",goldenrod:"daa520",gray:"808080",green:"008000",greenyellow:"adff2f",honeydew:"f0fff0",hotpink:"ff69b4",indianred:"cd5c5c",indigo:"4b0082",ivory:"fffff0",khaki:"f0e68c",lavender:"e6e6fa",lavenderblush:"fff0f5",lawngreen:"7cfc00",lemonchiffon:"fffacd",lightblue:"add8e6",lightcoral:"f08080",lightcyan:"e0ffff",lightgoldenrodyellow:"fafad2",lightgrey:"d3d3d3",lightgreen:"90ee90",lightpink:"ffb6c1",lightsalmon:"ffa07a",lightseagreen:"20b2aa",lightskyblue:"87cefa",lightslateblue:"8470ff",lightslategray:"778899",lightsteelblue:"b0c4de",lightyellow:"ffffe0",lime:"00ff00",limegreen:"32cd32",linen:"faf0e6",magenta:"ff00ff",maroon:"800000",mediumaquamarine:"66cdaa",mediumblue:"0000cd",mediumorchid:"ba55d3",mediumpurple:"9370d8",mediumseagreen:"3cb371",mediumslateblue:"7b68ee",mediumspringgreen:"00fa9a",mediumturquoise:"48d1cc",mediumvioletred:"c71585",midnightblue:"191970",mintcream:"f5fffa",mistyrose:"ffe4e1",moccasin:"ffe4b5",navajowhite:"ffdead",navy:"000080",oldlace:"fdf5e6",olive:"808000",olivedrab:"6b8e23",orange:"ffa500",orangered:"ff4500",orchid:"da70d6",palegoldenrod:"eee8aa",palegreen:"98fb98",paleturquoise:"afeeee",palevioletred:"d87093",papayawhip:"ffefd5",peachpuff:"ffdab9",peru:"cd853f",pink:"ffc0cb",plum:"dda0dd",powderblue:"b0e0e6",purple:"800080",red:"ff0000",rosybrown:"bc8f8f",royalblue:"4169e1",saddlebrown:"8b4513",salmon:"fa8072",sandybrown:"f4a460",seagreen:"2e8b57",seashell:"fff5ee",sienna:"a0522d",silver:"c0c0c0",skyblue:"87ceeb",slateblue:"6a5acd",slategray:"708090",snow:"fffafa",springgreen:"00ff7f",steelblue:"4682b4",tan:"d2b48c",teal:"008080",thistle:"d8bfd8",tomato:"ff6347",turquoise:"40e0d0",violet:"ee82ee",violetred:"d02090",wheat:"f5deb3",white:"ffffff",whitesmoke:"f5f5f5",yellow:"ffff00",yellowgreen:"9acd32"},t=/^(\w{2})(\w{2})(\w{2})$/,r=/^rgb\((\d{1,3}),\s*(\d{1,3}),\s*(\d{1,3})\)$/,i=/^rgba\((\d{1,3}),\s*(\d{1,3}),\s*(\d{1,3},\s*(\d{1,3}))\)$/,n=function(e){if(this.strokeColor=[1,0,0,1],this.fillColor=[1,0,0,1],this.fillTextureUrl=null,this.fillTexture=null,this.fillShader=null,this.strokeWidth=1,this.iconUrl=null,this.icon=null,this.label=null,this.textColor=[1,1,1,1],this.fill=!1,this.pointMaxSize=40,this.opacity=1,e)for(var t in e)this[t]=e[t]};return n.fromStringToColor=function(n){var o,s=0,a=0,l=0,h=255;return n=n.trim(),n=n.toLowerCase(),"#"==n.charAt(0)&&(n=n.substr(1,6)),e.hasOwnProperty(n)&&(n=e[n]),o=t.exec(n),o&&(s=parseInt(o[1],16),a=parseInt(o[2],16),l=parseInt(o[3],16)),o=r.exec(n),o&&(s=parseInt(o[1]),a=parseInt(o[2]),l=parseInt(o[3])),o=i.exec(n),o&&(s=parseInt(o[1]),a=parseInt(o[2]),l=parseInt(o[3]),h=parseInt(o[4])),s=0>s?0:s>255?255:s,a=0>a?0:a>255?255:a,l=0>l?0:l>255?255:l,h=0>h?0:h>255?255:h,[s/255,a/255,l/255,h/255]},n.fromColorToString=function(e){for(var t="#",r=0;3>r;r++){var i=parseInt(255*e[r]).toString(16);t+=10>i?"0"+i:i}return t},n.prototype.isEqualForPoly=function(e){return this.fill==e.fill},n.prototype.isEqualForLine=function(e){return this.strokeColor[0]==e.strokeColor[0]&&this.strokeColor[1]==e.strokeColor[1]&&this.strokeColor[2]==e.strokeColor[2]&&this.strokeColor[3]==e.strokeColor[3]&&this.strokeWidth==e.strokeWidth},n.prototype.isEqualForPoint=function(e){return this.iconUrl==e.iconUrl&&this.icon==e.icon&&this.label==e.label},n}),r("VectorLayer",["./Utils","./BaseLayer","./FeatureStyle"],function(e,t,r){var i=function(e){t.prototype.constructor.call(this,e),this.style=e&&e.style?e.style:new r,this.features=[]};return e.inherits(t,i),i.prototype._attach=function(e){t.prototype._attach.call(this,e);for(var r=0;this.features.length>r;r++)this._addFeatureToRenderers(this.features[r])},i.prototype._detach=function(){for(var e=0;this.features.length>e;e++)this._removeFeatureFromRenderers(this.features[e]);t.prototype._detach.call(this)},i.prototype.addFeatureCollection=function(e){var t=e.features;if(t)for(var r=0;t.length>r;r++)this.addFeature(t[r])},i.prototype.removeFeatureCollection=function(e){var t=e.features;if(t)for(var r=0;t.length>r;r++)this.removeFeature(t[r])},i.prototype._addFeatureToRenderers=function(e){var t=e.geometry,r=this.style,i=e.properties;if(i&&i.style&&(r=i.style),"GeometryCollection"==t.type)for(var n=t.geometries,o=0;n.length>o;o++)this.globe.vectorRendererManager.addGeometry(n[o],this,r);else this.globe.vectorRendererManager.addGeometry(t,this,r)},i.prototype._removeFeatureFromRenderers=function(e){var t=e.geometry;if("GeometryCollection"==t.type)for(var r=t.geometries,i=0;r.length>i;i++)this.globe.vectorRendererManager.removeGeometry(r[i],this);else this.globe.vectorRendererManager.removeGeometry(t,this)},i.prototype.addFeature=function(e){var t=e.geometry;t&&t.type&&(this.features.push(e),this.globe&&(this._addFeatureToRenderers(e),this._visible&&this.globe.renderContext.requestFrame()))},i.prototype.removeFeature=function(e){var t=this.features.indexOf(e);this.features.splice(t,1),this.globe&&(this._removeFeatureFromRenderers(e),this._visible&&this.globe.renderContext.requestFrame())},i.prototype.removeAllFeatures=function(){if(this.globe)for(var e=0;this.features.length>e;e++)this._removeFeatureFromRenderers(feature);this.features.length=0,this.globe&&this._visible&&this.globe.renderContext.requestFrame()},i.prototype.modifyFeatureStyle=function(e,t){this._removeFeatureFromRenderers(e),e.properties.style=t,this._addFeatureToRenderers(e)},i.prototype.modifyStyle=function(e){for(var t=0;this.features.length>t;t++)this._removeFeatureFromRenderers(this.features[t]);this.style=e;for(var t=0;this.features.length>t;t++)this._addFeatureToRenderers(this.features[t])},i}),r("HEALPixTables",[],function(){var e={ctab:[0,1,256,257,2,3,258,259,512,513,768,769,514,515,770,771,4,5,260,261,6,7,262,263,516,517,772,773,518,519,774,775,1024,1025,1280,1281,1026,1027,1282,1283,1536,1537,1792,1793,1538,1539,1794,1795,1028,1029,1284,1285,1030,1031,1286,1287,1540,1541,1796,1797,1542,1543,1798,1799,8,9,264,265,10,11,266,267,520,521,776,777,522,523,778,779,12,13,268,269,14,15,270,271,524,525,780,781,526,527,782,783,1032,1033,1288,1289,1034,1035,1290,1291,1544,1545,1800,1801,1546,1547,1802,1803,1036,1037,1292,1293,1038,1039,1294,1295,1548,1549,1804,1805,1550,1551,1806,1807,2048,2049,2304,2305,2050,2051,2306,2307,2560,2561,2816,2817,2562,2563,2818,2819,2052,2053,2308,2309,2054,2055,2310,2311,2564,2565,2820,2821,2566,2567,2822,2823,3072,3073,3328,3329,3074,3075,3330,3331,3584,3585,3840,3841,3586,3587,3842,3843,3076,3077,3332,3333,3078,3079,3334,3335,3588,3589,3844,3845,3590,3591,3846,3847,2056,2057,2312,2313,2058,2059,2314,2315,2568,2569,2824,2825,2570,2571,2826,2827,2060,2061,2316,2317,2062,2063,2318,2319,2572,2573,2828,2829,2574,2575,2830,2831,3080,3081,3336,3337,3082,3083,3338,3339,3592,3593,3848,3849,3594,3595,3850,3851,3084,3085,3340,3341,3086,3087,3342,3343,3596,3597,3852,3853,3598,3599,3854,3855],utab:[0,1,4,5,16,17,20,21,64,65,68,69,80,81,84,85,256,257,260,261,272,273,276,277,320,321,324,325,336,337,340,341,1024,1025,1028,1029,1040,1041,1044,1045,1088,1089,1092,1093,1104,1105,1108,1109,1280,1281,1284,1285,1296,1297,1300,1301,1344,1345,1348,1349,1360,1361,1364,1365,4096,4097,4100,4101,4112,4113,4116,4117,4160,4161,4164,4165,4176,4177,4180,4181,4352,4353,4356,4357,4368,4369,4372,4373,4416,4417,4420,4421,4432,4433,4436,4437,5120,5121,5124,5125,5136,5137,5140,5141,5184,5185,5188,5189,5200,5201,5204,5205,5376,5377,5380,5381,5392,5393,5396,5397,5440,5441,5444,5445,5456,5457,5460,5461,16384,16385,16388,16389,16400,16401,16404,16405,16448,16449,16452,16453,16464,16465,16468,16469,16640,16641,16644,16645,16656,16657,16660,16661,16704,16705,16708,16709,16720,16721,16724,16725,17408,17409,17412,17413,17424,17425,17428,17429,17472,17473,17476,17477,17488,17489,17492,17493,17664,17665,17668,17669,17680,17681,17684,17685,17728,17729,17732,17733,17744,17745,17748,17749,20480,20481,20484,20485,20496,20497,20500,20501,20544,20545,20548,20549,20560,20561,20564,20565,20736,20737,20740,20741,20752,20753,20756,20757,20800,20801,20804,20805,20816,20817,20820,20821,21504,21505,21508,21509,21520,21521,21524,21525,21568,21569,21572,21573,21584,21585,21588,21589,21760,21761,21764,21765,21776,21777,21780,21781,21824,21825,21828,21829,21840,21841,21844,21845],jrll:[2,2,2,2,3,3,3,3,4,4,4,4],jpll:[1,3,5,7,0,2,4,6,1,3,5,7],xoffset:[-1,-1,0,1,1,1,0,-1],yoffset:[0,1,1,1,0,-1,-1,-1],facearray:[[8,9,10,11,-1,-1,-1,-1,10,11,8,9],[5,6,7,4,8,9,10,11,9,10,11,8],[-1,-1,-1,-1,5,6,7,4,-1,-1,-1,-1],[4,5,6,7,11,8,9,10,11,8,9,10],[0,1,2,3,4,5,6,7,8,9,10,11],[1,2,3,0,0,1,2,3,5,6,7,4],[-1,-1,-1,-1,7,4,5,6,-1,-1,-1,-1],[3,0,1,2,3,0,1,2,4,5,6,7],[2,3,0,1,-1,-1,-1,-1,0,1,2,3]],swaparray:[[0,0,3],[0,0,6],[0,0,0],[0,0,5],[0,0,0],[5,0,0],[0,0,0],[6,0,0],[3,0,0]],swap_cycle:[[],[0,1,8,12,16,21,40],[0,1,2,40,114],[0,4,160,263],[0,4,30,49,51,87,526,1027,1105,1387,1807,2637],[0,8,10,18,39,74,146,307,452,4737],[0,1,2,7,9,17,80,410,1526,1921,32859,33566,38931],[0,5,6,10,12,24,27,95,372,494,924,1409,3492,4248,9137,66043,103369,156899],[0,1,2,3,4,45,125,351,697,24337,102940,266194,341855,419857],[0,1,2,3,9,16,1705,2082,2126,8177,12753,15410,52642,80493,83235,88387,99444,1675361,2495125],[0,2,6,8,9,11,20,50,93,152,183,2137,13671,44794,486954,741908,4803258,5692573],[0,1,5,6,44,53,470,2847,3433,4906,13654,14710,400447,1797382,2744492,18775974,23541521],[0,4,9,10,16,33,83,117,318,451,5759,10015,128975,171834,211256,347608,1278690,2154097,2590798,3427694,5581717,21012301,27023976,72522811,95032729,139166747,171822389],[0,5,10,267,344,363,2968,3159,9083,18437,76602,147614,1246902,1593138,2035574,6529391,9511830,11340287,29565945,281666026,677946848]]};
return e}),r("Long",[],function(){var e=function(e,t){this.low_=0|e,this.high_=0|t};return e.IntCache_={},e.fromInt=function(t){if(t>=-128&&128>t){var r=e.IntCache_[t];if(r)return r}var i=new e(0|t,0>t?-1:0);return t>=-128&&128>t&&(e.IntCache_[t]=i),i},e.fromNumber=function(t){return isNaN(t)||!isFinite(t)?e.ZERO:-e.TWO_PWR_63_DBL_>=t?e.MIN_VALUE:t+1>=e.TWO_PWR_63_DBL_?e.MAX_VALUE:0>t?e.fromNumber(-t).negate():new e(0|t%e.TWO_PWR_32_DBL_,0|t/e.TWO_PWR_32_DBL_)},e.fromBits=function(t,r){return new e(t,r)},e.TWO_PWR_16_DBL_=65536,e.TWO_PWR_24_DBL_=1<<24,e.TWO_PWR_32_DBL_=e.TWO_PWR_16_DBL_*e.TWO_PWR_16_DBL_,e.TWO_PWR_64_DBL_=e.TWO_PWR_32_DBL_*e.TWO_PWR_32_DBL_,e.TWO_PWR_63_DBL_=e.TWO_PWR_64_DBL_/2,e.ZERO=e.fromInt(0),e.ONE=e.fromInt(1),e.MAX_VALUE=e.fromBits(-1,2147483647),e.MIN_VALUE=e.fromBits(0,-2147483648),e.TWO_PWR_24_=e.fromInt(1<<24),e.prototype.toInt=function(){return this.low_},e.prototype.toNumber=function(){return this.high_*e.TWO_PWR_32_DBL_+this.getLowBitsUnsigned()},e.prototype.getLowBitsUnsigned=function(){return this.low_>=0?this.low_:e.TWO_PWR_32_DBL_+this.low_},e.prototype.isZero=function(){return 0==this.high_&&0==this.low_},e.prototype.isNegative=function(){return 0>this.high_},e.prototype.isOdd=function(){return 1==(1&this.low_)},e.prototype.equals=function(e){return this.high_==e.high_&&this.low_==e.low_},e.prototype.lessThan=function(e){return 0>this.compare(e)},e.prototype.greaterThanOrEqual=function(e){return this.compare(e)>=0},e.prototype.compare=function(e){if(this.equals(e))return 0;var t=this.isNegative(),r=e.isNegative();return t&&!r?-1:!t&&r?1:this.subtract(e).isNegative()?-1:1},e.prototype.negate=function(){return this.equals(e.MIN_VALUE)?e.MIN_VALUE:this.not().add(e.ONE)},e.prototype.add=function(t){var r=this.high_>>>16,i=65535&this.high_,n=this.low_>>>16,o=65535&this.low_,s=t.high_>>>16,a=65535&t.high_,l=t.low_>>>16,h=65535&t.low_,u=0,f=0,c=0,d=0;return d+=o+h,c+=d>>>16,d&=65535,c+=n+l,f+=c>>>16,c&=65535,f+=i+a,u+=f>>>16,f&=65535,u+=r+s,u&=65535,e.fromBits(c<<16|d,u<<16|f)},e.prototype.subtract=function(e){return this.add(e.negate())},e.prototype.multiply=function(t){if(this.isZero())return e.ZERO;if(t.isZero())return e.ZERO;if(this.equals(e.MIN_VALUE))return t.isOdd()?e.MIN_VALUE:e.ZERO;if(t.equals(e.MIN_VALUE))return this.isOdd()?e.MIN_VALUE:e.ZERO;if(this.isNegative())return t.isNegative()?this.negate().multiply(t.negate()):this.negate().multiply(t).negate();if(t.isNegative())return this.multiply(t.negate()).negate();if(this.lessThan(e.TWO_PWR_24_)&&t.lessThan(e.TWO_PWR_24_))return e.fromNumber(this.toNumber()*t.toNumber());var r=this.high_>>>16,i=65535&this.high_,n=this.low_>>>16,o=65535&this.low_,s=t.high_>>>16,a=65535&t.high_,l=t.low_>>>16,h=65535&t.low_,u=0,f=0,c=0,d=0;return d+=o*h,c+=d>>>16,d&=65535,c+=n*h,f+=c>>>16,c&=65535,c+=o*l,f+=c>>>16,c&=65535,f+=i*h,u+=f>>>16,f&=65535,f+=n*l,u+=f>>>16,f&=65535,f+=o*a,u+=f>>>16,f&=65535,u+=r*h+i*l+n*a+o*s,u&=65535,e.fromBits(c<<16|d,u<<16|f)},e.prototype.not=function(){return e.fromBits(~this.low_,~this.high_)},e.prototype.and=function(t){return e.fromBits(this.low_&t.low_,this.high_&t.high_)},e.prototype.or=function(t){return e.fromBits(this.low_|t.low_,this.high_|t.high_)},e.prototype.shiftRightUnsigned=function(t){if(t&=63,0==t)return this;var r=this.high_;if(32>t){var i=this.low_;return e.fromBits(i>>>t|r<<32-t,r>>>t)}return 32==t?e.fromBits(r,0):e.fromBits(r>>>t-32,0)},e}),r("HEALPixBase",["./HEALPixTables","./Long"],function(e,t){var r=1.570796325,i=function(e,t){0>e&&(e+=360);var r=e*Math.PI/180,i=(-t+90)*Math.PI/180;return[r,i]},n=function(e,t){if(e>=0)return t>e?e:e%t;var r=e%t+t;return r==t?0:r},o=function(t){return e.utab[255&t]|e.utab[255&t>>>8]<<16|e.utab[255&t>>>16]<<32|e.utab[255&t>>>24]<<48},s=function(e,t,r,i){return(r<<2*i)+o(e)+(o(t)<<1)},a=function(e,r,i){var o=Math.pow(2,e),a=Math.cos(i),r=r,l={phi:r,theta:i,z:a};Math.abs(a)>.9&&(l.sth=Math.sin(i),l.have_sth=!0);var h=2/Math.PI,u=n(r*h,4),f=Math.abs(a);if(2/3>=f){var c,d=o*(.5+u),m=o*.75*a,p=t.fromNumber(d-m),v=t.fromNumber(d+m),g=p.shiftRightUnsigned(e),x=v.shiftRightUnsigned(e);c=g.equals(x)?g.or(t.fromInt(4)):g.lessThan(x)?g:x.add(t.fromInt(8));var b=t.fromNumber(o-1),y=v.and(b),T=b.subtract(p.and(b));return s(y.toInt(),T.toInt(),c.toInt(),e)}var R=parseInt(Math.min(3,parseInt(u))),_=u-R,E=.9>f||!l.have_sth?o*Math.sqrt(3*(1-f)):o*l.sth/Math.sqrt((1+f)/3),p=t.fromNumber(_*E),v=t.fromNumber((1-_)*E),M=t.fromNumber(o),b=t.fromNumber(o-1),A=t.fromInt(1);return p.greaterThanOrEqual(M)&&(p=b),v.greaterThanOrEqual(M)&&(v=b),a>=0?s(M.subtract(v).subtract(A).toInt(),M.subtract(p).subtract(A).toInt(),R,e):s(p.toInt(),v.toInt(),R+8,e)},l={compress_bits:function(r){var i=t.fromNumber(r),n=t.fromNumber(0x5555555555555),o=i.and(n),s=o.shiftRightUnsigned(15);o=o.or(s);var a=o.and(t.fromNumber(65535)).toInt(),l=o.shiftRightUnsigned(32),h=l.and(t.fromNumber(65535)).toInt();return e.ctab[255&a]|e.ctab[a>>>8]<<4|e.ctab[255&h]<<16|e.ctab[h>>>8]<<20},fxyf:function(t,i,n){var o,s=e.jrll[n]-t-i,a=0,l=0,h=0,u=!1;if(1>s){o=s;var f=o*o/3;a=1-f,a>.99&&(h=Math.sqrt(f*(2-f)),u=!0)}else if(s>3){o=4-s;var f=o*o/3;a=f-1,-.99>a&&(h=Math.sqrt(f*(2-f)),u=!0)}else o=1,a=2*(2-s)/3;var f=e.jpll[n]*o+t-i;0>f&&(f+=8),f>=8&&(f-=8),l=1e-15>o?0:.5*r*f/o;var c=u?h:Math.sqrt((1-a)*(1+a));return[c*Math.cos(l),c*Math.sin(l),a]},nside2order:function(e){for(var t=0;e>65535;)t+=16,e>>>=16;return e>255&&(t|=8,e>>>=8),e>15&&(t|=4,e>>>=4),e>3&&(t|=2,e>>>=2),e>1&&(t|=1),t},lonLat2pix:function(e,t,r){var n=i(t,r);return a(e,n[0],n[1])}};return l}),r("AstroCoordTransform",[],function(){var e=2*Math.PI,t=4*Math.PI,r=180/Math.PI,i=[[.57595865315,4.9261918136,0,0,.11129056012,4.7005372834],[.574770433,4.9368292465,0,0,.11142137093,4.71279419371]],n=[[.88781538514,-.88781538514,.39788119938,-.39788119938,.86766174755,-.86766174755],[.88998808748,-.88998808748,.39777715593,-.39777715593,.86766622025,-.86766622025]],o=[[.46019978478,.46019978478,.9174369467,.9174369467,.49715499774,.49715499774],[.45598377618,.45598377618,.91748206207,.91748206207,.49714719172,.49714719172]],s=[[4.9261918136,.57595865315,0,0,4.7005372834,.11129056012],[4.9368292465,.574770433,0,0,4.71279419371,.11142137093]],a={transform:function(r,a){var l,h,u,f,c,d,m,p=1;return u=r[0]-s[p][a],f=r[1],c=Math.sin(f),d=Math.cos(f),m=d*Math.sin(u),f=-n[p][a]*m+o[p][a]*c,f=Math.max(-1,Math.min(f,1)),h=Math.asin(f),u=Math.atan2(o[p][a]*m+n[p][a]*c,d*Math.cos(u)),l=(u+i[p][a]+t)%e,[l,h]},transformInDeg:function(a,l){var h,u,f,c,d,m,p,v=1;return f=a[0]/r-s[v][l],c=a[1]/r,d=Math.sin(c),m=Math.cos(c),p=m*Math.sin(f),c=-n[v][l]*p+o[v][l]*d,c=Math.max(-1,Math.min(c,1)),u=Math.asin(c)*r,f=Math.atan2(o[v][l]*p+n[v][l]*d,m*Math.cos(f)),h=(f+i[v][l]+t)%e*r,[h,u]}};return a.Type={EQ2GAL:0,GAL2EQ:1,EQ2ECL:2,ECL2EQ:3,ECL2GAL:4,GAL2ECL:5},a}),r("HEALPixTiling",["./Tile","./HEALPixBase","./GeoBound","./CoordinateSystem","./Numeric","./AstroCoordTransform"],function(e,t,r,i,n,o){var s=function(e,t){this.order=e,this.nside=Math.pow(2,this.order),this.coordSystem=t.coordSystem||"EQUATORIAL"};s.prototype.generateLevelZeroTiles=function(t,r){t.skirt=!1,t.cullSign=-1,t.tesselation=5,t.coordSystem=this.coordSystem;for(var i=[],n=Math.pow(this.nside,2),o=12,s=o*n,l=0;s>l;l++){var h=Math.floor(l/n),u=new a(this.order,l,h);u.config=t,i.push(u),u.generate(r),u.state=e.State.NONE}return i},s.prototype.lonlat2LevelZeroIndex=function(){return 0},s.prototype.findInsideTile=function(e,r,i){for(var n=0;i.length>n;n++){var o=i[n],s=t.lonLat2pix(o.order,e,r);if(s==o.pixelIndex)return o}return null};var a=function(t,r,i){e.prototype.constructor.call(this),this.order=t,this.nside=Math.pow(2,this.order),this.pixelIndex=r,this.face=i;var n=27,o=29;this.texTransform=[64/1728,64/1856,this.pixelIndex%n/n,Math.floor(this.pixelIndex/n)/o],this.geoBound=null};return a.prototype=new e,a.prototype.createChildren=function(){var e=new a(this.order+1,4*this.pixelIndex,this.face),t=new a(this.order+1,4*this.pixelIndex+2,this.face),r=new a(this.order+1,4*this.pixelIndex+1,this.face),i=new a(this.order+1,4*this.pixelIndex+3,this.face);e.initFromParent(this,0,0),t.initFromParent(this,1,0),r.initFromParent(this,0,1),i.initFromParent(this,1,1),this.children=[e,t,r,i]},a.prototype.computeLocalMatrix=function(e){for(var t=mat4.create(),r=vec3.create(),i=vec3.create(),n=vec3.create(),o=0,s=0,a=0,l=0;e.length>l;l++)o+=e[l][0],s+=e[l][1],a+=e[l][2];var h=vec3.create([o/e.length,s/e.length,a/e.length]);return vec3.set(h,n),vec3.normalize(n),vec3.subtract(e[0],e[3],i),vec3.cross(n,i,r),vec3.normalize(r),vec3.cross(n,r,i),vec3.normalize(i),t[0]=r[0],t[1]=r[1],t[2]=r[2],t[3]=0,t[4]=i[0],t[5]=i[1],t[6]=i[2],t[7]=0,t[8]=n[0],t[9]=n[1],t[10]=n[2],t[11]=0,t[12]=h[0],t[13]=h[1],t[14]=h[2],t[15]=1,t},a.prototype.generateVertices=function(){for(var e=this.config.tesselation,n=[],s=1/(e-1),a=this.pixelIndex&this.nside*this.nside-1,l=t.compress_bits(a),h=t.compress_bits(a>>>1),u=0;e>u;u++)for(var f=0;e>f;f++)if("GALACTIC"==this.config.coordSystem){var c=t.fxyf((l+u*s)/this.nside,(h+f*s)/this.nside,this.face),d=i.from3DToGeo(c),m=o.transformInDeg(d,o.Type.GAL2EQ);n[u*e+f]=i.fromGeoTo3D(m)}else n[u*e+f]=t.fxyf((l+u*s)/this.nside,(h+f*s)/this.nside,this.face);this.geoBound=new r;var p=[];p.push(i.from3DToGeo(n[0])),p.push(i.from3DToGeo(n[e-1])),p.push(i.from3DToGeo(n[e*(e-1)])),p.push(i.from3DToGeo(n[e*e-1])),this.geoBound.computeFromCoordinates(p),this.matrix=this.computeLocalMatrix(n);var v=mat4.create();mat4.inverse(this.matrix,v),this.inverseMatrix=v;for(var g=new Float32Array(3*e*e),x=0,b=0;n.length>b;b++)g[x]=v[0]*n[b][0]+v[4]*n[b][1]+v[8]*n[b][2]+v[12],g[x+1]=v[1]*n[b][0]+v[5]*n[b][1]+v[9]*n[b][2]+v[13],g[x+2]=v[2]*n[b][0]+v[6]*n[b][1]+v[10]*n[b][2]+v[14],x+=3;return g},s}),r("RendererTileData",[],function(){var e=function(){this.renderables=[],this.frameNumber=-1};return e.prototype.getRenderable=function(e){for(var t=0;this.renderables.length>t;t++)if(e==this.renderables[t].bucket)return this.renderables[t];return null},e.prototype.dispose=function(e,t){for(var r=0;this.renderables.length>r;r++)this.renderables[r].dispose(e,t);this.renderables.length=0},e}),r("RasterOverlayRenderer",["./Program","./Tile","./RendererTileData"],function(e,t,r){var i=function(t){var r="	attribute vec3 vertex;\n	attribute vec2 tcoord;\n	uniform mat4 modelViewMatrix;\n	uniform mat4 projectionMatrix;\n	uniform vec4 textureTransform; \n	varying vec2 texCoord;\n	void main(void) \n	{\n		gl_Position = projectionMatrix * modelViewMatrix * vec4(vertex, 1.0);\n		texCoord = tcoord * textureTransform.xy + textureTransform.zw;\n	}\n	",i="	precision lowp float;\n	varying vec2 texCoord;\n	uniform sampler2D overlayTexture;\n	uniform float opacity; \n	void main(void)\n	{\n		gl_FragColor.rgba = texture2D(overlayTexture, texCoord.xy); \n		gl_FragColor.a *= opacity; \n	}\n	";this.requestHighestResolutionFirst=!0,this.tileManager=t,this.program=new e(t.renderContext),this.program.createFromSource(r,i),this.overlays=[],this.imageRequests=[],this.frameNumber=0;for(var n=this,o=0;4>o;o++){var s=new Image;s.renderable=null,s.frameNumber=-1,s.crossOrigin="",s.onload=function(){this.renderable&&(this.renderable.texture=t.tilePool.createGLTexture(this),this.renderable.onRequestFinished(!0),this.renderable=null,n.tileManager.renderContext.requestFrame())},s.onerror=function(){this.renderable&&(this.renderable.onRequestFinished(!0),this.renderable=null)},s.onabort=function(){console.log("Raster overlay request abort."),this.renderable&&(this.renderable.onRequestFinished(!1),this.renderable=null)},this.imageRequests.push(s)}this.needsOffset=!0},n=function(e){this.bucket=e,this.texture=null,this.request=null,this.requestFinished=!1};n.prototype.onRequestStarted=function(e){this.request=e,this.requestFinished=!1;var t=this.bucket;0==t._numRequests&&t.globe.publish("startLoad",t),t._numRequests++},n.prototype.onRequestFinished=function(e){this.request=null,this.requestFinished=e;var t=this.bucket;t._numRequests--,0==t._numRequests&&t.globe.publish("endLoad",t)},n.prototype.dispose=function(e,t){this.texture&&(t.disposeGLTexture(this.texture),this.texture=null)},i.prototype.addOverlay=function(e){e._numRequests=0,this.overlays.push(e);for(var r=0;this.tileManager.level0Tiles.length>r;r++){var i=this.tileManager.level0Tiles[r];i.state==t.State.LOADED&&this.addOverlayToTile(i,e)}},i.prototype.removeOverlay=function(e){var t=this.overlays.indexOf(e);this.overlays.splice(t,1);var r=this.tileManager.renderContext,i=this.tileManager.tilePool;this.tileManager.visitTiles(function(t){var n=t.extension.rasterOverlay,o=n?n.getRenderable(e):null;if(o){var s=n.renderables.indexOf(o);n.renderables.splice(s,1),o.dispose(r,i),0==n.renderables.length&&delete t.extension.rasterOverlay}})},i.prototype.addOverlayToTile=function(e,i){if(e.extension.rasterOverlay||(e.extension.rasterOverlay=new r),e.extension.rasterOverlay.renderables.push(new n(i)),e.children)for(var o=0;4>o;o++)e.children[o].state==t.State.LOADED&&this.overlayIntersects(e.children[o].geoBound,i)&&this.addOverlayToTile(e.children[o],i)};var o=function(e,t,r){return[t[0]+e*(r[0]-t[0]),t[1]+e*(r[1]-t[1])]};return i.prototype.clipPolygonToSide=function(e,t,r,i){for(var n=[],s=0;i.length>s;s++){var a=i[s],l=i[(s+1)%i.length],h=a[e],u=l[e],f=(h-r)*t>=0,c=(u-r)*t>=0;if(!f&&c){var d=(r-h)/(u-h),m=o(d,a,l);n.push(m),n.push(l)}else if(f&&c)n.push(l);else if(f&&!c){var d=(r-h)/(u-h),m=o(d,a,l);n.push(m)}}return n},i.prototype.overlayIntersects=function(e,t){if(t.coordinates){var r;return r=this.clipPolygonToSide(0,1,e.west,t.coordinates),r=this.clipPolygonToSide(0,-1,e.east,r),r=this.clipPolygonToSide(1,1,e.south,r),r=this.clipPolygonToSide(1,-1,e.north,r),r.length>0}return t.geoBound?t.geoBound.intersects(e):!0},i.prototype.generate=function(e){if(e.parent)for(var t=e.parent.extension.rasterOverlay,r=t?t.renderables.length:0,i=0;r>i;i++){var n=t.renderables[i].bucket;this.overlayIntersects(e.geoBound,n)&&this.addOverlayToTile(e,n)}else for(var i=0;this.overlays.length>i;i++){var n=this.overlays[i];this.overlayIntersects(e.geoBound,n)&&this.addOverlayToTile(e,n)}},i.prototype.requestOverlayTextureForTile=function(e,t){if(t.request)t.request.frameNumber=this.frameNumber;else{for(var r,i=0;this.imageRequests.length>i;i++)if(!this.imageRequests[i].renderable){r=this.imageRequests[i];break}r&&(t.onRequestStarted(r),r.renderable=t,r.frameNumber=this.frameNumber,r.src=t.bucket.getUrl(e))}},i.prototype.render=function(e){if(0!=this.overlays.length){var r=this.tileManager.renderContext,i=r.gl;this.program.apply();var n=this.program.attributes;i.uniformMatrix4fv(this.program.uniforms.projectionMatrix,!1,r.projectionMatrix),i.uniform1i(this.program.uniforms.overlayTexture,0),i.enable(i.BLEND),i.blendFunc(i.SRC_ALPHA,i.ONE_MINUS_SRC_ALPHA),i.depthFunc(i.LEQUAL);for(var o=mat4.create(),s=null,a=0;e.length>a;a++){var l,h=e[a],u=h.state==t.State.LOADED;if(u?l=h.extension.rasterOverlay:h.parent&&(l=h.parent.extension.rasterOverlay),l){mat4.multiply(r.viewMatrix,h.matrix,o),i.uniformMatrix4fv(this.program.uniforms.modelViewMatrix,!1,o),i.bindBuffer(i.ARRAY_BUFFER,h.vertexBuffer),i.vertexAttribPointer(n.vertex,3,i.FLOAT,!1,0,0);var f=u?this.tileManager.tileIndexBuffer.getSolid():this.tileManager.tileIndexBuffer.getSubSolid(h.parentIndex);s!=f&&(i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,f),s=f);for(var c=0;l.renderables.length>c;c++){var d=l.renderables[c];if(d.bucket._visible){var m=1,p=0,v=0,g=u?h:h.parent;if(g){var x=g;for(this.requestHighestResolutionFirst&&(d.requestFinished||this.requestOverlayTextureForTile(g,d));!d.requestFinished&&g;)if(x=g,g=g.parent){p*=.5,v*=.5,m*=.5,p+=1&x.parentIndex?.5:0,v+=2&x.parentIndex?.5:0;var b=g.extension.rasterOverlay;d=b.getRenderable(d.bucket)}this.requestHighestResolutionFirst||x!=g&&this.requestOverlayTextureForTile(x,d),g&&d.texture&&(u?h.geoBound:h.parent.geoBound,i.uniform1f(this.program.uniforms.opacity,d.bucket._opacity),i.uniform4f(this.program.uniforms.textureTransform,m,m,p,v),i.activeTexture(i.TEXTURE0),i.bindTexture(i.TEXTURE_2D,d.texture),i.drawElements(i.TRIANGLES,s.numIndices,i.UNSIGNED_SHORT,0))}}}}}i.disable(i.BLEND),i.depthFunc(i.LESS);for(var a=0;this.imageRequests.length>a;a++){var y=this.imageRequests[a];y.renderable&&y.frameNumber<this.frameNumber&&(y.renderable.onRequestFinished(!1),y.renderable=null,y.src="")}this.frameNumber++}},i}),r("RasterLayer",["./Utils","./BaseLayer","./RasterOverlayRenderer"],function(e,t,r){var i=function(e){t.prototype.constructor.call(this,e),this.tilePixelSize=-1,this.tiling=null,this.numberOfLevels=-1,this.geoBound=e.geoBound||null,this.coordinates=e.coordinates||null,this._overlay=!0,this._ready=!0};return e.inherits(t,i),i.prototype._attach=function(e){if(this._overlay||(this.id=0),t.prototype._attach.call(this,e),this._overlay){if(!e.rasterOverlayRenderer){var i=new r(e.tileManager);e.tileManager.addPostRenderer(i),e.rasterOverlayRenderer=i}e.rasterOverlayRenderer.addOverlay(this)}},i.prototype._detach=function(){this._overlay&&this.globe.rasterOverlayRenderer&&this.globe.rasterOverlayRenderer.removeOverlay(this),t.prototype._detach.call(this)},i}),r("HEALPixLayer",["./Utils","./HEALPixTiling","./RasterLayer"],function(e,t,r){var i=function(e){r.prototype.constructor.call(this,e),this.tilePixelSize=e.tilePixelSize||512,this.tiling=new t(e.baseLevel||3,e),this.numberOfLevels=e.numberOfLevels||10,this.type="ImageryRaster",this.baseUrl=e.baseUrl,this.levelZeroImage=new Image;var i=this;this.levelZeroImage.crossOrigin="",this.levelZeroImage.onload=function(){i._ready=!0,e.onready&&e.onready instanceof Function&&e.onready(i),i.globe&&i.globe.renderContext.requestFrame()},this.levelZeroImage.onerror=function(){console.log("Cannot load "+i.levelZeroImage.src)},this._ready=!1};return e.inherits(r,i),i.prototype._attach=function(e){r.prototype._attach.call(this,e),this.levelZeroImage.src=this.baseUrl+"/Norder3/Allsky.jpg"},i.prototype.getUrl=function(e){var t=this.baseUrl;t+="/Norder",t+=e.order,t+="/Dir";var r=1e4*Math.floor(e.pixelIndex/1e4);return t+=r,t+="/Npix",t+=e.pixelIndex,t+=".jpg"},i}),r("OpenSearchLayer",["./FeatureStyle","./VectorRendererManager","./Utils","./BaseLayer","./RendererTileData"],function(e,t,r,i,n){var o=function(t){i.prototype.constructor.call(this,t),this.serviceUrl=t.serviceUrl,this.minOrder=t.minOrder||5,this.maxRequests=t.maxRequests||2,this.requestProperties="",this.style=t&&t.style?t.style:new e,this.extId="os",this.features=[],this.featuresSet={},this.freeRequests=[];for(var r=0;this.maxRequests>r;r++){var n=new XMLHttpRequest;this.freeRequests.push(n)}this.pointBucket=null,this.polygonBucket=null,this.polygonRenderer=null,this.pointRenderer=null};r.inherits(i,o),o.prototype._attach=function(e){i.prototype._attach.call(this,e),this.extId+=this.id,e.tileManager.addPostRenderer(this)},o.prototype._detach=function(){this.globe.tileManager.removePostRenderer(this),this.pointRenderer=null,this.pointBucket=null,this.polygonRenderer=null,this.polygonBucket=null,i.prototype._detach.call(this)},o.prototype.updateChildrenState=function(e){if(e.children)for(var t=0;4>t;t++)e.children[t].extension[this.extId]&&(e.children[t].extension[this.extId].state=o.TileState.INHERIT_PARENT,e.children[t].extension[this.extId].complete=!0),this.updateChildrenState(e.children[t])},o.prototype.launchRequest=function(e,t){var r=e.extension[this.extId];if(0!=this.freeRequests.length){r.state=o.TileState.LOADING,""!=this.requestProperties&&(t+="&"+this.requestProperties),this.maxRequests==this.freeRequests.length&&this.globe.publish("startLoad",this);var i=this.freeRequests.pop(),s=this;i.onreadystatechange=function(){if(4==i.readyState){if(200==i.status){var t=JSON.parse(i.response);if(r.complete=t.totalResults==t.features.length,r.complete&&s.updateChildrenState(e),s.updateFeatures(t.features),t.features.length>0)for(var a=0;t.features.length>a;a++)s.addFeature(t.features[a],e);else e.extension.pointSprite=new n}else i.status>=400&&console.error(i.responseText);r.state=o.TileState.LOADED,s.freeRequests.push(i),s.maxRequests==s.freeRequests.length&&s.globe.publish("endLoad",s)}},i.open("GET",t),i.send()}},o.prototype.setRequestProperties=function(e){for(var t in this.featuresSet)for(var r=this.featuresSet[t],i=0;r.tiles.length>i;i++){var n=r.tiles[i],s=this.features[r.index];this.removeFeatureFromRenderer(s,n)}var a=this;this.globe.tileManager.visitTiles(function(e){e.extension[a.extId]&&(e.extension[a.extId].dispose(),e.extension[a.extId].featureIds=[],e.extension[a.extId].state=o.TileState.NOT_LOADED,e.extension[a.extId].complete=!1)}),this.featuresSet={},this.features=[],this.requestProperties="";for(var l in e)""!=this.requestProperties&&(this.requestProperties+="&"),this.requestProperties+=l+"="+e[l]},o.prototype.addFeature=function(e,t){var r,i=t.extension[this.extId];if(this.featuresSet.hasOwnProperty(e.properties.identifier)){r=this.featuresSet[e.properties.identifier],e=this.features[r.index];for(var n=!1,o=0;r.tiles.length>o;o++)t.order==r.tiles[o].order&&t.pixelIndex==r.tiles[o].pixelIndex&&(n=!0,console.log("OpenSearchLayer internal error : tile already there! "+t.order+" "+t.pixelIndex));n||r.tiles.push(t)}else this.features.push(e),r={index:this.features.length-1,tiles:[t]},this.featuresSet[e.properties.identifier]=r;i.featureIds.push(e.properties.identifier),e.geometry.gid=e.properties.identifier,this.addFeatureToRenderer(e,t)},o.prototype.addFeatureToRenderer=function(e,t){"Point"==e.geometry.type?(this.pointRenderer||(this.pointRenderer=this.globe.vectorRendererManager.getRenderer("PointSprite"),this.pointBucket=this.pointRenderer.getOrCreateBucket(this,this.style)),this.pointRenderer.addGeometryToTile(this.pointBucket,e.geometry,t)):"Polygon"==e.geometry.type&&(this.polygonRenderer||(this.polygonRenderer=this.globe.vectorRendererManager.getRenderer("ConvexPolygon"),this.polygonBucket=this.polygonRenderer.getOrCreateBucket(this,this.style)),this.polygonRenderer.addGeometryToTile(this.polygonBucket,e.geometry,t))},o.prototype.removeFeatureFromRenderer=function(e,t){"Point"==e.geometry.type?this.pointRenderer.removeGeometryFromTile(e.geometry,t):"Polygon"==e.geometry.type&&this.polygonRenderer.removeGeometryFromTile(e.geometry,t)},o.prototype.removeFeature=function(e,t){var r=this.featuresSet[e];if(r){var i=r.tiles.indexOf(t);if(i>=0?r.tiles.splice(i,1):console.log("OpenSearchLayer internal error : tile not found when removing feature"),0==r.tiles.length){delete this.featuresSet[e];var n=this.features.pop();r.index<this.features.length&&(this.features[r.index]=n,this.featuresSet[n.properties.identifier].index=r.index)}}},o.prototype.modifyFeatureStyle=function(e,t){e.properties.style=t;var r=this.featuresSet[e.properties.identifier];if(r){var i;"Point"==e.geometry.type?i=this.pointRenderer:"Polygon"==e.geometry.type&&(i=this.polygonRenderer);for(var n=i.getOrCreateBucket(this,t),o=0;r.tiles.length>o;o++)i.removeGeometryFromTile(e.geometry,r.tiles[o]),i.addGeometryToTile(n,e.geometry,r.tiles[o])}},o.TileState={LOADING:0,LOADED:1,NOT_LOADED:2,INHERIT_PARENT:3},o.prototype.generate=function(e){var t=e.extension[this.extId];if(!t){if(e.parent){var r=e.parent.extension[this.extId];t=new s(this,e),t.state=r.complete?o.TileState.INHERIT_PARENT:o.TileState.NOT_LOADED,t.complete=r.complete}else t=new s(this,e);e.extension[this.extId]=t}};var s=function(e,t){this.layer=e,this.tile=t,this.featureIds=[],this.state=o.TileState.NOT_LOADED,this.complete=!1};return s.prototype.dispose=function(){for(var e=0;this.featureIds.length>e;e++)this.layer.removeFeature(this.featureIds[e],this.tile);this.tile=null},o.prototype.buildUrl=function(e){return url=this.serviceUrl+"/search?order="+e.order+"&healpix="+e.pixelIndex},o.prototype.render=function(e){if(this._visible)for(var t=0;e.length>t&&this.freeRequests.length>0;t++){var r=e[t];if(r.order>=this.minOrder){var i=r.extension[this.extId];if(!i||i.state==o.TileState.NOT_LOADED){for(;r.parent&&r.parent.order>=this.minOrder&&r.parent.extension[this.extId]&&r.parent.extension[this.extId].state==o.TileState.NOT_LOADED;)r=r.parent;if(r.extension[this.extId]&&r.extension[this.extId].state==o.TileState.NOT_LOADED){if(r.parent&&r.parent.extension[this.extId].state==o.TileState.LOADING)continue;var n=this.buildUrl(r);n&&this.launchRequest(r,n)}}}}},o.prototype.updateFeatures=function(e){for(var t=0;e.length>t;t++){var r=e[t];switch(r.geometry.type){case"Point":r.geometry.coordinates[0]>180&&(r.geometry.coordinates[0]-=360);break;case"Polygon":for(var i=r.geometry.coordinates[0],n=0;i.length>n;n++)i[n][0]>180&&(i[n][0]-=360);break;default:}}},o}),r("TileWireframeLayer",["./Utils","./BaseLayer","./Program","./Tile"],function(e,t,r,i){var n=function(e){t.prototype.constructor.call(this,e),this.outline=e&&e.outline?e.outline:!1,this.globe=null,this.program=null,this.indexBuffer=null,this.subIndexBuffer=[null,null,null,null]};return e.inherits(t,n),n.prototype.buildIndexBuffer=function(){for(var e=this.globe.renderContext.gl,t=this.globe.tileManager.tileConfig.tesselation,r=[],i=this.outline?t-1:1,n=0;t>n;n+=i)for(var o=0;t-1>o;o++)r.push(n*t+o),r.push(n*t+o+1);for(var n=0;t>n;n+=i)for(var o=0;t-1>o;o++)r.push(o*t+n),r.push((o+1)*t+n);var s=e.createBuffer();e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,s),e.bufferData(e.ELEMENT_ARRAY_BUFFER,new Uint16Array(r),e.STATIC_DRAW),s.numIndices=r.length,this.indexBuffer=s;var a=(t-1)/2;i=this.outline?a:1;for(var l=0;4>l;l++){for(var o=l%2,n=Math.floor(l/2),r=[],h=a*n;a*(n+1)+1>h;h+=i)for(var u=a*o;a*(o+1)>u;u++)r.push(h*t+u),r.push(h*t+u+1);for(var h=a*o;a*(o+1)+1>h;h+=i)for(var u=a*n;a*(n+1)>u;u++)r.push(u*t+h),r.push((u+1)*t+h);var s=e.createBuffer();e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,s),e.bufferData(e.ELEMENT_ARRAY_BUFFER,new Uint16Array(r),e.STATIC_DRAW),s.numIndices=r.length,this.subIndexBuffer[l]=s}},n.prototype._attach=function(e){if(t.prototype._attach.call(this,e),this._visible&&this.globe.tileManager.addPostRenderer(this),!this.program){var i="		attribute vec3 vertex;\n		uniform mat4 modelViewMatrix;\n		uniform mat4 projectionMatrix;\n		void main(void) \n		{\n			gl_Position = projectionMatrix * modelViewMatrix * vec4(vertex, 1.0);\n		}\n		",n="		precision highp float; \n		uniform float alpha; \n		void main(void)\n		{\n				gl_FragColor = vec4(1.0,1.0,1.0,alpha);\n		}\n		";this.program=new r(this.globe.renderContext),this.program.createFromSource(i,n),this.buildIndexBuffer()}},n.prototype._detach=function(){this.globe.tileManager.removePostRenderer(this),t.prototype._detach.call(this)},n.prototype.render=function(e){var t=this.globe.renderContext,r=t.gl;r.enable(r.BLEND),this.program.apply(),r.uniformMatrix4fv(this.program.uniforms.projectionMatrix,!1,t.projectionMatrix);for(var n=this.program.attributes.vertex,o=null,s=0;e.length>s;s++){var a=e[s],l=a.state==i.State.LOADED,h=-1==a.parentIndex;mat4.multiply(t.viewMatrix,a.matrix,t.modelViewMatrix),r.uniformMatrix4fv(this.program.uniforms.modelViewMatrix,!1,t.modelViewMatrix),r.uniform1f(this.program.uniforms.alpha,this.opacity()),r.bindBuffer(r.ARRAY_BUFFER,a.vertexBuffer),r.vertexAttribPointer(n,3,r.FLOAT,!1,4*a.config.vertexSize,0);var u=l||h?this.indexBuffer:this.subIndexBuffer[a.parentIndex];o!=u&&(r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,u),o=u),o.numIndices,r.drawElements(r.LINES,o.numIndices,r.UNSIGNED_SHORT,0)}r.disable(r.BLEND)},n.prototype.visible=function(e){return"boolean"==typeof e&&this._visible!=e&&(this._visible=e,e?this.globe.tileManager.addPostRenderer(this):this.globe.tileManager.removePostRenderer(this)),this._visible},n}),r("MouseNavigationHandler",[],function(){var e=function(e){var t=null,r=-1,i=-1,n=-1,o=!1,s=!1,a=0,l=0,h=function(e){t.globe.publish("startNavigation");var r;return r=void 0===e.wheelDelta?e.detail:-e.wheelDelta/120,t.zoom(r),t.stopAnimations(),t.inertia&&t.inertia.launch("zoom",0>r?-1:1),e.preventDefault&&e.preventDefault(),e.returnValue=!1,t.globe.publish("endNavigation"),t.globe.renderContext.requestFrame(),!1},u=function(e){return document.addEventListener("mouseup",f),r=e.button,t.stopAnimations(),0==e.button||1==e.button?(i=e.clientX,n=e.clientY,a=0,l=0,o=!0,!1):!0},f=function(e){return r=-1,document.removeEventListener("mouseup",f),!t.inertia||0==a&&0==l||(0==e.button&&t.inertia.launch("pan",a,l),1==e.button&&t.inertia.launch("rotate",a,l)),0==e.button||1==e.button?(s&&t.globe.publish("endNavigation"),o=!1,s=!1,!1):!0},c=function(e){if(!(0>r)&&(a=e.clientX-i,l=e.clientY-n,0!=a||0!=l)){var h=!1;return 0==r?(o&&(t.globe.publish("startNavigation"),o=!1,s=!0),t.pan(a,l),t.globe.renderContext.requestFrame(),h=!0):1==r&&(t.rotate(a,l),t.globe.renderContext.requestFrame(),h=!0),i=e.clientX,n=e.clientY,h}},d=function(e){if(0==e.button){var r=t.globe.renderContext.getXYRelativeToCanvas(e),i=t.globe.getLonLatFromPixel(r[0],r[1]);i&&t.zoomTo(i)}};this.install=function(r){t=r;var i=t.globe.renderContext.canvas;i.addEventListener("mousedown",u),i.addEventListener("mousemove",c),e.zoomOnDblClick&&i.addEventListener("dblclick",d),i.addEventListener("DOMMouseScroll",h),i.addEventListener("mousewheel",h)},this.uninstall=function(){var r=t.globe.renderContext.canvas;r.removeEventListener("mousedown",u),r.removeEventListener("mousemove",c),e.zoomOnDblClick&&r.removeEventListener("dblclick",d),r.removeEventListener("DOMMouseScroll",h),r.removeEventListener("mousewheel",h)}};return e}),r("KeyboardNavigationHandler",[],function(){var e=function(e){var t=null,r=this;this.panFactor=10,this.zoomFactor=1,e&&(e.panFactor&&"number"==typeof e.panFactor&&(this.panFactor=e.panFactor),e.zoomFactor&&"number"==typeof e.zoomFactor&&(this.zoomFactor=e.zoomFactor));var i=function(){return this.focus(),!1},n=function(e){switch(e.keyCode){case 32:t.stopAnimations();break;case 187:case 61:case 107:t.zoom(-r.zoomFactor);break;case 189:case 54:case 109:t.zoom(r.zoomFactor);break;case 81:case 37:e.shiftKey?t.rotate(r.panFactor,0):t.pan(r.panFactor,0);break;case 90:case 38:e.shiftKey?t.rotate(0,r.panFactor):t.pan(0,r.panFactor);break;case 68:case 39:e.shiftKey?t.rotate(-r.panFactor,0):t.pan(-r.panFactor,0);break;case 83:case 40:e.shiftKey?t.rotate(0,-r.panFactor):t.pan(0,-r.panFactor)}t.globe.renderContext.requestFrame()};this.install=function(r){if(t=r,e&&e.installOnDocument)document.addEventListener("keydown",n);else{var o=t.globe.renderContext.canvas;o.addEventListener("keydown",n),o.tabIndex="0",o.addEventListener("mousedown",i)}},this.uninstall=function(){if(e&&e.installOnDocument)document.removeEventListener("keydown",n);else{var r=t.globe.renderContext.canvas;r.removeEventListener("keydown",n),r.removeEventListener("mousedown",i)}}};return e}),r("Animation",[],function(){var e=function(){this.startTime=-1,this.pauseTime=-1,this.globe=null};return e.prototype._unregisterActive=function(){var e=this.globe.activeAnimations.indexOf(this);this.globe.activeAnimations.splice(e,1)},e.prototype.getStatus=function(){return-1==this.startTime?"STOPPED":-1==this.pauseTime?"RUNNING":"PAUSED"},e.prototype.start=function(){if(this.globe&&(-1==this.startTime||-1!=this.pauseTime)){var e=Date.now();-1==this.startTime?this.startTime=e:(this.startTime+=e-this.pauseTime,this.pauseTime=-1),this.globe.activeAnimations.push(this),this.globe.renderContext.requestFrame()}},e.prototype.pause=function(){this.globe&&-1!=this.startTime&&-1==this.pauseTime&&(this.pauseTime=Date.now(),this._unregisterActive(this))},e.prototype.stop=function(){this.startTime=-1,this.pauseTime=-1,this.onstop&&this.onstop(),this._unregisterActive(this)},e}),r("InertiaAnimation",["./Utils","./Animation"],function(e,t){var r=.1,i=function(e,r){t.prototype.constructor.call(this),r&&(this.panFactor=r.hasOwnProperty("panFactor")?r.panFactor:.95,this.rotateFactor=r.hasOwnProperty("rotateFactor")?r.rotateFactor:.95,this.zoomFactor=r.hasOwnProperty("zoomFactor")?r.zoomFactor:.95),this.type=null,this.dx=0,this.dy=0,this.navigation=e,this.navigation.globe.addAnimation(this)};return e.inherits(t,i),i.prototype.update=function(){var e=!1;switch(this.type){case"pan":this.navigation.pan(this.dx,this.dy),this.dx*=this.panFactor,this.dy*=this.panFactor,e=r>Math.abs(this.dx)&&r>Math.abs(this.dy);
break;case"rotate":this.navigation.rotate(this.dx,this.dy),this.dx*=this.rotateFactor,this.dy*=this.rotateFactor,e=r>Math.abs(this.dx)&&r>Math.abs(this.dy);break;case"zoom":this.navigation.zoom(this.dx),this.dx*=this.zoomFactor,e=r>Math.abs(this.dx);break;default:}this.navigation.globe.renderContext.requestFrame(),e&&this.stop()},i.prototype.launch=function(e,t,r){this.type=e,this.dx=t,this.dy=r,this.start()},i}),r("BaseNavigation",["./MouseNavigationHandler","./KeyboardNavigationHandler","./InertiaAnimation"],function(e,t,r){var i=function(i,n){this.globe=i;for(var o in n)this[o]=n[o];this.handlers||(this.handlers=[new e({zoomOnDblClick:!0}),new t]),n&&n.inertia&&(this.inertia=new r(this,n)),this.zoomToAnimation=null,this.start()};return i.prototype.start=function(){for(var e=0;this.handlers.length>e;e++)this.handlers[e].install(this)},i.prototype.stop=function(){for(var e=0;this.handlers.length>e;e++)this.handlers[e].uninstall()},i.prototype.stopAnimations=function(){this.inertia&&this.inertia.stop(),this.zoomToAnimation&&(this.zoomToAnimation.stop(),this.zoomToAnimation=null)},i.prototype.getFov=function(){var e=this.globe.renderContext.canvas.width/this.globe.renderContext.canvas.height;return[e*this.globe.renderContext.fov,this.globe.renderContext.fov]},i}),r("SegmentedAnimation",["./Utils","./Animation","./Numeric"],function(e,t,r){var i=function(e,r){t.prototype.constructor.call(this),this.segments=[],this.duration=e,this.valueSetter=r};e.inherits(t,i);var n=function(e,t,r,i,n){this.start=e,this.startValue=t,this.end=r,this.endValue=i,this.interpolator=n};return i.prototype.addSegment=function(e,t,r,i,o){for(var s=this.segments.length,a=0;s>a&&e>=this.segments[a].end;)a++;this.segments.splice(a,0,new n(e,t,r,i,o))},i.prototype.update=function(e){var t=r.map01(e,this.startTime,this.startTime+this.duration);if(t>=1){var i=this.segments.length-1;this.valueSetter(this.segments[i].endValue),this.stop()}else{for(var n=this.segments.length,o=0;n>o&&t>this.segments[o].end;)o++;o=Math.min(o,n-1),t=r.map01(t,this.segments[o].start,this.segments[o].end);var s=this.segments[o].interpolator(t,this.segments[o].startValue,this.segments[o].endValue);this.valueSetter(s)}},i}),r("AstroNavigation",["./Utils","./CoordinateSystem","./BaseNavigation","./SegmentedAnimation","./Numeric","./glMatrix"],function(e,t,r,i,n){var o=function(e,t){this.minFov=.25,this.maxFov=100,r.prototype.constructor.call(this,e,t),this.center3d=[1,0,0],this.up=[0,0,1],this.computeViewMatrix()};return e.inherits(r,o),o.prototype.zoomTo=function(e,r,o){var s=this,a=r||15;o=o||5e3;var l=[];t.from3DToGeo(this.center3d,l);var h=[l[0],l[1],this.globe.renderContext.fov],u=[e[0],e[1],a];Math.abs(e[0]-l[0])>180&&(l[0]<e[0]?h[0]+=360:u[0]+=360);var f=new i(o,function(e){var r=t.fromGeoTo3D([e[0],e[1]]);s.center3d[0]=r[0],s.center3d[1]=r[1],s.center3d[2]=r[2],this.globe.renderContext.fov=e[2],s.computeViewMatrix()});f.addSegment(0,h,1,u,function(e,t,r){var i=n.easeOutQuad(e),o=n.easeInQuad(e);return[n.lerp(i,t[0],r[0]),n.lerp(i,t[1],r[1]),n.lerp(o,t[2],r[2])]}),f.onstop=function(){s.globe.publish("endNavigation")},this.globe.addAnimation(f),f.start(),this.zoomToAnimation=f,this.globe.publish("startNavigation")},o.prototype.moveTo=function(e,r){var o=this;r=r||5e3;var s=[];t.from3DToGeo(this.center3d,s);var a=[s[0],s[1]],l=[e[0],e[1]];Math.abs(e[0]-s[0])>180&&(s[0]<e[0]?a[0]+=360:l[0]+=360);var h=new i(r,function(e){var r=t.fromGeoTo3D([e[0],e[1]]);o.center3d[0]=r[0],o.center3d[1]=r[1],o.center3d[2]=r[2],o.computeViewMatrix()});h.addSegment(0,a,1,l,function(e,t,r){var i=n.easeOutQuad(e);return[n.lerp(i,t[0],r[0]),n.lerp(i,t[1],r[1])]}),h.onstop=function(){o.globe.publish("endNavigation")},this.globe.addAnimation(h),h.start(),this.globe.publish("startNavigation")},o.prototype.computeViewMatrix=function(){vec3.normalize(this.center3d);var e=this.globe.renderContext.viewMatrix;mat4.lookAt([0,0,0],this.center3d,this.up,e),this.up=[e[1],e[5],e[9]]},o.prototype.zoom=function(e){this.globe.publish("startNavigation"),e=1+.1*e,this.globe.renderContext.fov*=e,this.globe.renderContext.fov>this.maxFov&&(this.globe.renderContext.fov=this.maxFov),this.globe.renderContext.fov<this.minFov&&(this.globe.renderContext.fov=this.minFov),this.computeViewMatrix(),this.globe.publish("endNavigation")},o.prototype.pan=function(e,t){var r=this.globe.renderContext.canvas.width/2,i=this.globe.renderContext.canvas.height/2;this.center3d=this.globe.renderContext.get3DFromPixel(r-e,i-t),this.computeViewMatrix()},o.prototype.rotate=function(e){var t=.1*e*Math.PI/180,r=quat4.fromAngleAxis(t,this.center3d);quat4.multiplyVec3(r,this.up),this.computeViewMatrix()},o}),r("Stats",[],function(){var e=function(e,t){e.renderContext.stats=this,this.globe=e;var r=t?t.element:void 0;r&&(this.element="string"==typeof r?document.getElementById(r):r),this.showFPS=e.renderContext.continuousRendering,this.verbose=t&&t.verbose?t.verbose:!1,this.numFrames=0;var i=this;window.setInterval(function(){i.print()},1e3)};return e.prototype.start=function(e){this[e]=Date.now()},e.prototype.end=function(e){var t=Date.now()-this[e],r=this["max_"+e]||-1;t>r&&(r=t);var i=this["sum_"+e]||0;i+=t,this[e]=t,this["max_"+e]=r,this["sum_"+e]=i,"globalRenderTime"==e&&this.numFrames++},e.prototype.print=function(){if(this.numFrames>0){var e="";this.showFPS&&(e+="FPS : "+this.numFrames+"<br>"),e+="Average render time : "+(this.sum_globalRenderTime/this.numFrames).toFixed(2)+" ms",e+="<br># rendered tiles : "+this.globe.tileManager.tilesToRender.length,this.verbose&&(e+="<br>Average traverse tiles time : "+(this.sum_traverseTime/this.numFrames).toFixed(2)+" ms",e+="<br>Average render tiles time : "+(this.sum_renderTime/this.numFrames).toFixed(2)+" ms",e+="<br>Average generate tiles time : "+(this.sum_generateTime/this.numFrames).toFixed(2)+" ms",e+="<br>Average request tiles time : "+(this.sum_requestTime/this.numFrames).toFixed(2)+" ms",e+="<br>Max render time : "+this.max_globalRenderTime+" ms",e+="<br>Max traverse tiles time : "+this.max_traverseTime+" ms",e+="<br>Max render tiles time : "+this.max_renderTime+" ms",e+="<br>Max generate tiles time : "+this.max_generateTime+" ms",e+="<br>Max request tiles time : "+this.max_requestTime+" ms"),this.element.innerHTML=e,this.sum_globalRenderTime=0,this.sum_traverseTime=0,this.sum_renderTime=0,this.sum_generateTime=0,this.sum_requestTime=0,this.max_globalRenderTime=0,this.max_traverseTime=0,this.max_renderTime=0,this.max_generateTime=0,this.max_requestTime=0,this.numFrames=0}},e}),r("PointSpriteRenderer",["./Program","./CoordinateSystem","./RendererTileData","./FeatureStyle","./VectorRendererManager"],function(e,t,r,i,n){var o=function(t){this.renderContext=t.renderContext,this.tileConfig=t.tileConfig,this.buckets=[],this.numberOfRenderPoints=0;var r="	attribute vec3 vertex; \n	uniform mat4 viewProjectionMatrix; \n	uniform float pointSize; \n	void main(void)  \n	{ \n		gl_Position = viewProjectionMatrix * vec4(vertex,1.0); \n		gl_PointSize = pointSize; \n	} \n	",i="	precision lowp float; \n	uniform sampler2D texture; \n	uniform float alpha; \n	uniform vec3 color; \n	\n	void main(void) \n	{ \n		vec4 textureColor = texture2D(texture, gl_PointCoord); \n		gl_FragColor = vec4(textureColor.rgb * color, textureColor.a * alpha); \n		if (gl_FragColor.a <= 0.0) discard; \n		//gl_FragColor = vec4(1.0); \n	} \n	";this.program=new e(this.renderContext),this.program.createFromSource(r,i),this.frameNumber=0,this.defaultTexture=null},s=function(e){this.bucket=e,this.geometry2vb={},this.vertices=[],this.vertexBuffer=null,this.vertexBufferDirty=!1};return s.prototype.add=function(e){this.geometry2vb[e.gid]=this.vertices.length;var r=t.fromGeoTo3D(e.coordinates);this.vertices.push(.99*r[0],.99*r[1],.99*r[2]),this.vertexBufferDirty=!0},s.prototype.remove=function(e){if(this.geometry2vb.hasOwnProperty(e.gid)){var t=this.geometry2vb[e.gid];delete this.geometry2vb[e.gid],this.vertices.splice(t,3),this.vertexBufferDirty=!0;for(var r in this.geometry2vb)r&&this.geometry2vb[r]>t&&(this.geometry2vb[r]-=3)}},s.prototype.dispose=function(e){this.vertexBuffer&&e.gl.deleteBuffer(this.vertexBuffer)},o.prototype._buildDefaultTexture=function(e){if(!this.defaultTexture){var t=this.renderContext.gl;this.defaultTexture=t.createTexture(),t.bindTexture(t.TEXTURE_2D,this.defaultTexture);var r=new Uint8Array([255,255,255,255]);t.texImage2D(t.TEXTURE_2D,0,t.RGBA,1,1,0,t.RGBA,t.UNSIGNED_BYTE,r)}e.texture=this.defaultTexture,e.textureWidth=10,e.textureHeight=10},o.prototype._buildTextureFromImage=function(e,t){e.texture=this.renderContext.createNonPowerOfTwoTextureFromImage(t),e.textureWidth=t.width,e.textureHeight=t.height},o.prototype.addGeometryToTile=function(e,t,i){var n=i.extension.pointSprite;n||(n=i.extension.pointSprite=new r);var o=n.getRenderable(e);o||(o=new s(e),n.renderables.push(o)),o.add(t)},o.prototype.removeGeometryFromTile=function(e,t){var r=t.extension.pointSprite;if(r)for(var i=0;r.renderables.length>i;i++)r.renderables[i].remove(e)},o.prototype.removeGeometry=function(){},o.prototype.getOrCreateBucket=function(e,t){for(var r=0;this.buckets.length>r;r++){var n=this.buckets[r];if(n.layer==e&&n.style.iconUrl==t.iconUrl&&n.style.icon==t.icon&&n.style.label==t.label&&n.style.fillColor[0]==t.fillColor[0]&&n.style.fillColor[1]==t.fillColor[1]&&n.style.fillColor[2]==t.fillColor[2])return n}var o=this.renderContext.gl;o.createBuffer();var n={style:new i(t),layer:e,texture:null};if(t.label){var s=Text.generateImageData(t.label,t.textColor);this._buildTextureFromImage(n,s)}else if(t.iconUrl){var a=new Image,l=this;a.onload=function(){l._buildTextureFromImage(n,a),l.renderContext.requestFrame()},a.onerror=function(){l._buildDefaultTexture(n)},a.src=t.iconUrl}else t.icon?this._buildTextureFromImage(n,t.icon):this._buildDefaultTexture(n);return this.buckets.push(n),n},o.prototype.render=function(e){var t=this.renderContext,r=this.renderContext.gl;r.enable(r.BLEND),r.blendEquation(r.FUNC_ADD),r.blendFunc(r.SRC_ALPHA,r.ONE_MINUS_SRC_ALPHA),this.program.apply(),mat4.multiply(t.projectionMatrix,t.viewMatrix,t.modelViewMatrix),r.uniformMatrix4fv(this.program.uniforms.viewProjectionMatrix,!1,t.modelViewMatrix),r.uniform1i(this.program.uniforms.texture,0);for(var i=0;e.length>i;i++){for(var n=e[i],o=n.extension.pointSprite;n.parent&&!o;)n=n.parent,o=n.extension.pointSprite;if(o&&o.frameNumber!=this.frameNumber){o.frameNumber=this.frameNumber;for(var s=0;o.renderables.length>s;s++){var a=o.renderables[s];if(a.bucket.layer._visible){r.uniform1f(this.program.uniforms.alpha,a.bucket.layer._opacity);var l=a.bucket.style.fillColor;r.uniform3f(this.program.uniforms.color,l[0],l[1],l[2]),r.uniform1f(this.program.uniforms.pointSize,a.bucket.textureWidth),a.vertexBuffer||(a.vertexBuffer=r.createBuffer()),r.bindBuffer(r.ARRAY_BUFFER,a.vertexBuffer),r.vertexAttribPointer(this.program.attributes.vertex,3,r.FLOAT,!1,0,0),a.vertexBufferDirty&&(r.bufferData(r.ARRAY_BUFFER,new Float32Array(a.vertices),r.STATIC_DRAW),a.vertexBufferDirty=!1),r.activeTexture(r.TEXTURE0),r.bindTexture(r.TEXTURE_2D,a.bucket.texture),r.drawArrays(r.POINTS,0,a.vertices.length/3)}}}}r.disable(r.BLEND),this.frameNumber++},n.registerRenderer({id:"PointSprite",creator:function(e){return new o(e.tileManager)},canApply:function(){return!1}}),o}),r("ConvexPolygonRenderer",["./Program","./CoordinateSystem","./RendererTileData","./FeatureStyle","./VectorRendererManager"],function(e,t,r,i,n){var o=function(e){this.renderContext=e.renderContext,this.tileConfig=e.tileConfig,this.programs=[],this.buckets=[],this.basicVertexShader="	attribute vec3 vertex;\n	uniform mat4 viewProjectionMatrix;\n	\n	void main(void)\n	{\n		gl_Position = viewProjectionMatrix * vec4(vertex, 1.0);\n	}\n	",this.basicFragmentShader="	precision lowp float; \n	uniform vec4 color; \n	\n	void main(void) \n	{ \n		gl_FragColor = color; \n	} \n	",this.texVertexShader="	attribute vec3 vertex;\n	attribute vec2 tcoord;\n	uniform mat4 viewProjectionMatrix;\n	\n	varying vec2 vTextureCoord;\n	\n	void main(void) \n	{\n		vTextureCoord = tcoord;\n		vTextureCoord.y = 1.0 - vTextureCoord.y; \n		gl_Position = viewProjectionMatrix * vec4(vertex, 1.0);\n	}\n	",this.texFragmentShader="		precision lowp float; \n		uniform vec4 color;\n		varying vec2 vTextureCoord;\n		uniform sampler2D texture; \n		void main(void)\n		{\n			gl_FragColor = texture2D(texture, vTextureCoord) * color;\n		}\n		",this.basicFillShader={vertexCode:this.basicVertexShader,fragmentCode:this.basicFragmentShader,updateUniforms:null},this.texFillShader={vertexCode:this.texVertexShader,fragmentCode:this.texFragmentShader,updateUniforms:null},this.basicProgram=this.createProgram(this.basicFillShader),this.texProgram=this.createProgram(this.texFillShader),this.frameNumber=0;var t=this.renderContext.gl;this.whiteTexture=t.createTexture(),t.bindTexture(t.TEXTURE_2D,this.whiteTexture);var r=new Uint8Array([255,255,255,255]);t.texImage2D(t.TEXTURE_2D,0,t.RGBA,1,1,0,t.RGBA,t.UNSIGNED_BYTE,r),this.tcoordBuffer=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,this.tcoordBuffer);var i=[0,0,1,0,1,1,0,1,0,0];t.bufferData(t.ARRAY_BUFFER,new Float32Array(i),t.STATIC_DRAW),this.tcoordBuffer.itemSize=2,this.tcoordBuffer.numItems=5},s=function(e){this.bucket=e,this.geometry2vb={},this.vertices=[],this.lineIndices=[],this.triangleIndices=[],this.vertexBuffer=null,this.lineIndexBuffer=null,this.triangleIndexBuffer=null,this.bufferDirty=!1,this.triBufferDirty=!1};return s.prototype.add=function(e){var r=[];if("MultiPolygon"==e.type)for(var i=0;e.coordinates.length>i;i++)r.push(e.coordinates[i][0]);else r.push(e.coordinates[0]);for(var n=0;r.length>n;n++){for(var o=r[n],s=o.length-1,a={vertexStart:this.vertices.length,vertexCount:3*s,lineIndexStart:this.lineIndices.length,lineIndexCount:2*s,triIndexStart:0,triIndexCount:0},l=this.vertices.length/3,i=0;s>i;i++){var h=t.fromGeoTo3D(o[i]);this.vertices.push(h[0],h[1],h[2]),this.lineIndices.push(l+i,l+(i+1)%s)}if(this.bucket.style.fill){a.triIndexStart=this.triangleIndices.length,a.triIndexCount=3*(s-2);for(var i=0;s-2>i;i++)this.triangleIndices.push(l,l+i+1,l+i+2)}this.geometry2vb[e.gid]?(this.geometry2vb[e.gid].vertexCount+=a.vertexCount,this.geometry2vb[e.gid].lineIndexCount+=a.lineIndexCount,this.geometry2vb[e.gid].triIndexCount+=a.triIndexCount):this.geometry2vb[e.gid]=a,this.bufferDirty=!0,this.triBufferDirty=!0}},s.prototype.remove=function(e){if(this.geometry2vb.hasOwnProperty(e.gid)){var t=this.geometry2vb[e.gid];delete this.geometry2vb[e.gid],this.vertices.splice(t.vertexStart,t.vertexCount);for(var r=t.lineIndexStart+t.lineIndexCount;this.lineIndices.length>r;r++)this.lineIndices[r]-=t.vertexCount/3;for(var r=t.triIndexStart+t.triIndexCount;this.triangleIndices.length>r;r++)this.triangleIndices[r]-=t.vertexCount/3;this.lineIndices.splice(t.lineIndexStart,t.lineIndexCount),this.triangleIndices.splice(t.triIndexStart,t.triIndexCount);for(var i in this.geometry2vb)if(i){var n=this.geometry2vb[i];n.vertexStart>t.vertexStart&&(n.vertexStart-=t.vertexCount,n.lineIndexStart-=t.lineIndexCount,n.triIndexStart-=t.triIndexCount)}this.bufferDirty=!0,this.triBufferDirty=!0}},s.prototype.dispose=function(e){this.vertexBuffer&&e.gl.deleteBuffer(this.vertexBuffer),this.lineIndexBuffer&&e.gl.deleteBuffer(this.lineIndexBuffer),this.triangleIndexBuffer&&e.gl.deleteBuffer(this.triangleIndexBuffer)},o.prototype.addGeometryToTile=function(e,t,i){var n=i.extension.polygon;n||(n=i.extension.polygon=new r);var o=n.getRenderable(e);o||(o=new s(e),n.renderables.push(o)),o.add(t)},o.prototype.removeGeometryFromTile=function(e,t){var r=t.extension.polygon;if(r)for(var i=0;r.renderables.length>i;i++)r.renderables[i].remove(e),0==r.renderables[i].vertices.length&&(r.renderables[i].dispose(this.renderContext),r.renderables.splice(i,1))},o.prototype.addGeometry=function(e,t,r){var i=this.getOrCreateBucket(t,r);i.mainRenderable||(i.mainRenderable=new s(i)),i.mainRenderable.add(e)},o.prototype.removeGeometry=function(e){for(var t=0;this.buckets.length>t;t++){var r=this.buckets[t];r.mainRenderable&&(r.mainRenderable.remove(e),0==r.mainRenderable.vertices.length&&(r.mainRenderable.dispose(this.renderContext),r.mainRenderable=null))}},o.prototype.createProgram=function(t){var r=new e(this.renderContext);return r.createFromSource(t.vertexCode,t.fragmentCode),r.id=this.programs.length,this.programs.push({fillShader:t,program:r,renderables:[]}),r},o.prototype.getProgram=function(e){for(var t,r=0;this.programs.length>r;r++)this.programs[r].fillShader==e&&(t=this.programs[r].program);return t||(t=this.createProgram(e)),t},o.prototype.getOrCreateBucket=function(e,t){for(var r=0;this.buckets.length>r;r++){var n=this.buckets[r];if(n.layer==e&&n.style.strokeColor[0]==t.strokeColor[0]&&n.style.strokeColor[1]==t.strokeColor[1]&&n.style.strokeColor[2]==t.strokeColor[2]&&n.style.fill==t.fill&&n.style.fillTexture==t.fillTexture&&n.style.fillTextureUrl==t.fillTextureUrl&&n.style.fillShader==t.fillShader)return n}var o=this.renderContext.gl;o.createBuffer();var n={style:new i(t),layer:e,polygonProgram:null,texture:null,mainRenderable:null,currentRenderables:[]},s=this;if(t.fill){var a=!1;if(t.fillTextureUrl){var l=new Image;l.crossOrigin="",l.onload=function(){n.texture=s.renderContext.createNonPowerOfTwoTextureFromImage(l)},l.onerror=function(){console.log("Cannot load "+l.src)},l.src=t.fillTextureUrl,a=!0}else t.fillTexture&&(n.texture=t.fillTexture,a=!0);t.fillShader&&t.fillShader.fragmentCode?(t.fillShader.vertexCode||(t.fillShader.vertexCode=this.texVertexShader),t.fillShader.vertexCode||(t.fillShader.fragmentCode=this.texFragmentShader),n.polygonProgram=this.getProgram(t.fillShader)):n.polygonProgram=a?this.texProgram:this.basicProgram}return this.buckets.push(n),n},o.prototype.render=function(e){var t=this.renderContext,r=this.renderContext.gl;r.disable(r.DEPTH_TEST),r.enable(r.BLEND),r.blendEquation(r.FUNC_ADD),r.blendFunc(r.SRC_ALPHA,r.ONE_MINUS_SRC_ALPHA);for(var i=0;e.length>i;i++){for(var n=e[i],o=n.extension.polygon;n.parent&&!o;)n=n.parent,o=n.extension.polygon;if(o&&o.frameNumber!=this.frameNumber){o.frameNumber=this.frameNumber;for(var s=0;o.renderables.length>s;s++)o.renderables[s].bucket.currentRenderables.push(o.renderables[s])}}this.basicProgram.apply(),mat4.multiply(t.projectionMatrix,t.viewMatrix,t.modelViewMatrix),r.uniformMatrix4fv(this.basicProgram.uniforms.viewProjectionMatrix,!1,t.modelViewMatrix);for(var i=0;this.buckets.length>i;i++){var a=this.buckets[i];if(a.layer.visible()){if(a.mainRenderable&&a.currentRenderables.push(a.mainRenderable),0!=a.currentRenderables.length){var l=a.style.strokeColor;r.uniform4f(this.basicProgram.uniforms.color,l[0],l[1],l[2],l[3]*a.layer.opacity());for(var s=0;a.currentRenderables.length>s;s++){var h=a.currentRenderables[s];h.vertexBuffer||(h.vertexBuffer=r.createBuffer(),h.lineIndexBuffer=r.createBuffer()),r.bindBuffer(r.ARRAY_BUFFER,h.vertexBuffer),r.vertexAttribPointer(this.basicProgram.attributes.vertex,3,r.FLOAT,!1,0,0),r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,h.lineIndexBuffer),h.bufferDirty&&(r.bufferData(r.ARRAY_BUFFER,new Float32Array(h.vertices),r.STATIC_DRAW),r.bufferData(r.ELEMENT_ARRAY_BUFFER,new Uint16Array(h.lineIndices),r.STATIC_DRAW),h.bufferDirty=!1),r.drawElements(r.LINES,h.lineIndices.length,r.UNSIGNED_SHORT,0),a.polygonProgram&&this.programs[a.polygonProgram.id].renderables.push(h)}a.currentRenderables.length=0}}else a.currentRenderables.length=0}for(var s=0;this.programs.length>s;s++)if(0!=this.programs[s].renderables.length){var u=this.programs[s].program;u.apply(),r.uniformMatrix4fv(u.uniforms.viewProjectionMatrix,!1,t.modelViewMatrix),r.uniform1i(u.uniforms.texture,0),r.activeTexture(r.TEXTURE0),r.bindBuffer(r.ARRAY_BUFFER,this.tcoordBuffer),r.vertexAttribPointer(u.attributes.tcoord,2,r.FLOAT,!1,0,0);for(var f=0;this.programs[s].renderables.length>f;f++)h=this.programs[s].renderables[f],this.programs[s].fillShader.updateUniforms&&this.programs[s].fillShader.updateUniforms(r,h.bucket),r.bindBuffer(r.ARRAY_BUFFER,h.vertexBuffer),r.vertexAttribPointer(u.attributes.vertex,3,r.FLOAT,!1,0,0),h.triangleIndexBuffer||(h.triangleIndexBuffer=r.createBuffer()),r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,h.triangleIndexBuffer),h.triBufferDirty&&(r.bufferData(r.ELEMENT_ARRAY_BUFFER,new Uint16Array(h.triangleIndices),r.STATIC_DRAW),h.triBufferDirty=!1),h.bucket.texture?(r.bindTexture(r.TEXTURE_2D,h.bucket.texture),r.uniform4f(u.uniforms.color,1,1,1,l[3]*h.bucket.layer.opacity())):(r.bindTexture(r.TEXTURE_2D,this.whiteTexture),l=h.bucket.style.fillColor,r.uniform4f(u.uniforms.color,l[0],l[1],l[2],l[3]*h.bucket.layer.opacity())),r.drawElements(r.TRIANGLES,h.triangleIndices.length,r.UNSIGNED_SHORT,0);this.programs[s].renderables.length=0}r.enable(r.DEPTH_TEST),r.disable(r.BLEND),this.frameNumber++},n.registerRenderer({id:"ConvexPolygon",creator:function(e){return new o(e.tileManager)},canApply:function(e){return"Polygon"==e||"MultiPolygon"==e}}),o}),r("AstroWeb",["./Globe","./VectorLayer","./HEALPixLayer","./OpenSearchLayer","./TileWireframeLayer","./AstroNavigation","./FeatureStyle","./Stats","./PointSpriteRenderer","./ConvexPolygonRenderer"],function(e,t,r,i,n,o,s,a){var l={};return l.Globe=e,l.VectorLayer=t,l.HEALPixLayer=r,l.OpenSearchLayer=i,l.TileWireframeLayer=n,l.AstroNavigation=o,l.FeatureStyle=s,l.Stats=a,window.AstroWeb=l,l}),t(["AstroWeb"])})();